{% extends 'accounts/onboarding/base.html' %}

{% block title %}Reminders - CSU Tracker{% endblock %}

{% block content %}
<div class="onboarding-step">
    <div class="onboarding-step__emoji">ðŸ””</div>
    
    <h1 class="onboarding-step__title">
        Daily reminders
    </h1>
    
    <p class="onboarding-step__subtitle">
        A gentle nudge helps build consistency. Logging takes about 30 seconds.
    </p>
    
    <form method="post" class="onboarding-form" id="reminders-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="next" id="form-action">
        
        <div class="onboarding-options onboarding-options--stacked">
            <label class="onboarding-option onboarding-option--wide">
                <input type="radio" name="enable_reminders" value="yes" 
                       {% if form.enable_reminders.value == 'yes' %}checked{% endif %}
                       class="onboarding-option__input"
                       onchange="toggleReminderSettings(true)">
                <span class="onboarding-option__card onboarding-option__card--detailed">
                    <span class="onboarding-option__icon">ðŸ””</span>
                    <span class="onboarding-option__label">Yes, remind me daily</span>
                    <span class="onboarding-option__description">Get a notification at your preferred time</span>
                </span>
            </label>
            
            <label class="onboarding-option onboarding-option--wide">
                <input type="radio" name="enable_reminders" value="no"
                       {% if form.enable_reminders.value == 'no' %}checked{% endif %}
                       class="onboarding-option__input"
                       onchange="toggleReminderSettings(false)">
                <span class="onboarding-option__card onboarding-option__card--detailed">
                    <span class="onboarding-option__icon">ðŸ”•</span>
                    <span class="onboarding-option__label">No thanks</span>
                    <span class="onboarding-option__description">I'll remember on my own</span>
                </span>
            </label>
        </div>
        
        <!-- Settings Panel (shown when reminders enabled) -->
        <div class="onboarding-reminder-settings" id="reminder-settings" style="{% if form.enable_reminders.value != 'yes' %}display: none;{% endif %}">
            <div class="onboarding-reminder-setting">
                <label class="onboarding-reminder-setting__label">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    Reminder time
                </label>
                <input type="time" name="reminder_time" 
                       value="{{ form.reminder_time.value|default:'20:00' }}"
                       class="onboarding-reminder-setting__input">
                <p class="onboarding-reminder-setting__hint">Evening works well for reflecting on your day</p>
            </div>
            
            <div class="onboarding-reminder-setting">
                <label class="onboarding-reminder-setting__label">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="2" y1="12" x2="22" y2="12"/>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                    </svg>
                    Your timezone
                </label>
                <select name="timezone" class="onboarding-reminder-setting__select">
                    {% for tz_value, tz_label in form.fields.timezone.choices %}
                    <option value="{{ tz_value }}" {% if form.timezone.value == tz_value %}selected{% endif %}>{{ tz_label }}</option>
                    {% endfor %}
                </select>
                <p class="onboarding-reminder-setting__hint">Reminders are sent at your local time</p>
            </div>
        </div>
        
        <p class="onboarding-reassurance">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4"/>
                <path d="M12 8h.01"/>
            </svg>
            You can change these settings anytime.
        </p>
    </form>
</div>

<script>
function toggleReminderSettings(show) {
    const settings = document.getElementById('reminder-settings');
    if (settings) {
        settings.style.display = show ? 'block' : 'none';
    }
}

// Convert VAPID key from base64 URL format to Uint8Array
function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}

// Subscribe to push notifications
async function subscribeToPush() {
    if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
        console.log('Push not supported');
        return false;
    }
    
    try {
        // Request permission
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
            console.log('Notification permission denied');
            return false;
        }
        
        // Get service worker registration
        const registration = await navigator.serviceWorker.ready;
        
        // Subscribe to push
        const subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array('{{ VAPID_PUBLIC_KEY }}')
        });
        
        // Send subscription to server
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const response = await fetch('/api/notifications/subscribe/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(subscription.toJSON())
        });
        
        if (response.ok) {
            console.log('Push subscription saved');
            return true;
        } else {
            console.error('Failed to save subscription');
            return false;
        }
    } catch (error) {
        console.error('Push subscription error:', error);
        return false;
    }
}

// Handle form submission
document.getElementById('reminders-form').addEventListener('submit', async function(e) {
    const enableReminders = document.querySelector('input[name="enable_reminders"]:checked');
    
    if (enableReminders && enableReminders.value === 'yes') {
        e.preventDefault();
        
        // Show loading state
        const submitBtn = document.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Setting up...';
        
        // Subscribe to push notifications
        await subscribeToPush();
        
        // Now submit the form
        submitBtn.textContent = originalText;
        this.submit();
    }
});
</script>
{% endblock %}

{% block navigation %}
<button type="submit" form="reminders-form" class="btn btn--primary btn--lg btn--full">
    Continue
</button>

<div class="onboarding-nav-row">
    <button type="button" onclick="document.getElementById('form-action').value='back'; document.getElementById('reminders-form').submit();" class="btn btn--ghost">
        Back
    </button>
    <button type="button" onclick="document.getElementById('form-action').value='skip'; document.getElementById('reminders-form').submit();" class="btn btn--ghost">
        Skip
    </button>
</div>
{% endblock %}
