{% extends 'base.html' %}

{% block title %}Notifications - CSU Tracker{% endblock %}

{% block content %}
<div class="px-4 py-6 max-w-md mx-auto fade-in">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900">Notifications</h1>
        <p class="text-gray-600 mt-1">Set up daily reminders</p>
    </div>
    
    <!-- Push Permission Card -->
    <div id="push-permission-card" class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-6 text-white mb-6">
        <div id="push-not-supported" class="hidden">
            <h3 class="font-semibold mb-2">‚ö†Ô∏è Not Supported</h3>
            <p class="text-indigo-100 text-sm">Push notifications are not supported in this browser. For the best experience on iPhone, add this app to your Home Screen.</p>
        </div>
        
        <div id="push-prompt" class="hidden">
            <h3 class="font-semibold mb-2">üîî Enable Notifications</h3>
            <p class="text-indigo-100 text-sm mb-4">Get daily reminders to log your CSU score.</p>
            <button id="enable-push-btn" class="bg-white text-indigo-600 py-2 px-4 rounded-lg font-semibold text-sm hover:bg-indigo-50 transition-colors">
                Enable Notifications
            </button>
        </div>
        
        <div id="push-enabled" class="hidden">
            <h3 class="font-semibold mb-2">‚úì Notifications Enabled</h3>
            <p class="text-indigo-100 text-sm">You have {{ subscriptions_count }} active device(s).</p>
        </div>
        
        <div id="push-denied" class="hidden">
            <h3 class="font-semibold mb-2">üö´ Notifications Blocked</h3>
            <p class="text-indigo-100 text-sm">Please enable notifications in your browser settings.</p>
        </div>
    </div>
    
    <!-- Reminder Settings -->
    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Daily Reminder</h3>
        
        <form method="post">
            {% csrf_token %}
            
            <div class="space-y-4">
                <!-- Enable Toggle -->
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                    <div>
                        <span class="font-medium text-gray-900">Enable reminders</span>
                        <p class="text-sm text-gray-500">Get a daily push notification</p>
                    </div>
                    {{ form.enabled }}
                </div>
                
                <!-- Time -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Reminder time</label>
                    {{ form.time_of_day }}
                    <p class="text-xs text-gray-500 mt-1">We'll remind you if you haven't logged by this time</p>
                </div>
                
                <!-- Timezone -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Your timezone</label>
                    {{ form.timezone }}
                </div>
                
                <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                    Save Settings
                </button>
            </div>
        </form>
    </div>
    
    <!-- Test Notification -->
    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Test Notification</h3>
        <p class="text-sm text-gray-500 mb-4">Send a test notification to verify your setup.</p>
        <button id="test-notification-btn" class="w-full bg-gray-100 text-gray-700 py-3 px-4 rounded-lg font-semibold hover:bg-gray-200 transition-colors">
            Send Test Notification
        </button>
    </div>
    
    <!-- iPhone Instructions -->
    <div class="bg-amber-50 rounded-2xl p-6 mb-6">
        <h3 class="font-semibold text-amber-800 mb-2">üì± iPhone Users</h3>
        <p class="text-sm text-amber-700 mb-2">For notifications to work on iPhone:</p>
        <ol class="text-sm text-amber-700 list-decimal list-inside space-y-1">
            <li>Tap the Share button in Safari</li>
            <li>Select "Add to Home Screen"</li>
            <li>Open the app from your Home Screen</li>
            <li>Enable notifications when prompted</li>
        </ol>
    </div>
    
    <!-- Debug Info -->
    <div class="bg-gray-100 rounded-2xl p-6">
        <h3 class="font-semibold text-gray-800 mb-2">üîß Debug Info</h3>
        <div id="debug-info" class="text-xs text-gray-600 font-mono space-y-1">
            <p>Loading...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const VAPID_PUBLIC_KEY = '{{ VAPID_PUBLIC_KEY }}';

function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}

async function updatePushUI() {
    const notSupported = document.getElementById('push-not-supported');
    const prompt = document.getElementById('push-prompt');
    const enabled = document.getElementById('push-enabled');
    const denied = document.getElementById('push-denied');
    
    // Hide all
    [notSupported, prompt, enabled, denied].forEach(el => el.classList.add('hidden'));
    
    if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
        notSupported.classList.remove('hidden');
        return;
    }
    
    const permission = Notification.permission;
    
    if (permission === 'denied') {
        denied.classList.remove('hidden');
    } else if (permission === 'granted') {
        enabled.classList.remove('hidden');
    } else {
        prompt.classList.remove('hidden');
    }
}

async function subscribeToPush() {
    try {
        const registration = await navigator.serviceWorker.ready;
        
        const subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
        });
        
        // Send subscription to server
        const response = await fetch('/api/notifications/subscribe/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(subscription.toJSON())
        });
        
        if (response.ok) {
            updatePushUI();
            alert('Notifications enabled!');
        } else {
            throw new Error('Failed to save subscription');
        }
    } catch (error) {
        console.error('Push subscription failed:', error);
        alert('Failed to enable notifications. Please try again.');
    }
}

document.getElementById('enable-push-btn')?.addEventListener('click', async () => {
    const permission = await Notification.requestPermission();
    if (permission === 'granted') {
        await subscribeToPush();
    }
    updatePushUI();
});

document.getElementById('test-notification-btn')?.addEventListener('click', async () => {
    const btn = document.getElementById('test-notification-btn');
    btn.disabled = true;
    btn.textContent = 'Sending...';
    
    try {
        const response = await fetch('/api/notifications/test/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        if (response.ok) {
            btn.textContent = 'Sent! Check your notifications';
        } else {
            throw new Error('Failed to send');
        }
    } catch (error) {
        btn.textContent = 'Failed - Try again';
    }
    
    setTimeout(() => {
        btn.disabled = false;
        btn.textContent = 'Send Test Notification';
    }, 3000);
});

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    updatePushUI();
    updateDebugInfo();
});

function updateDebugInfo() {
    const debugEl = document.getElementById('debug-info');
    if (!debugEl) return;
    
    const info = [];
    
    try {
        // Check standalone mode (PWA)
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches 
            || window.navigator.standalone === true;
        info.push('PWA Mode: ' + (isStandalone ? '‚úÖ YES' : '‚ùå NO (must open from Home Screen)'));
        
        // Check Service Worker support
        const hasSW = 'serviceWorker' in navigator;
        info.push('Service Worker: ' + (hasSW ? '‚úÖ Supported' : '‚ùå Not supported'));
        
        // Check Push API
        const hasPush = 'PushManager' in window;
        info.push('Push API: ' + (hasPush ? '‚úÖ Supported' : '‚ùå Not supported'));
        
        // Check Notification API
        const hasNotif = 'Notification' in window;
        info.push('Notification API: ' + (hasNotif ? '‚úÖ Supported' : '‚ùå Not supported'));
        
        // Check permission
        if (hasNotif) {
            info.push('Permission: ' + Notification.permission);
        }
        
        // VAPID key
        info.push('VAPID Key: ' + (VAPID_PUBLIC_KEY ? VAPID_PUBLIC_KEY.substring(0, 20) + '...' : '‚ùå MISSING'));
        
        // iOS version detection
        const iOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        info.push('iOS Device: ' + (iOS ? 'YES' : 'NO'));
        
        // Check SW registration async
        if (hasSW) {
            navigator.serviceWorker.getRegistration().then(reg => {
                const swInfo = 'SW Registered: ' + (reg ? '‚úÖ YES (scope: ' + reg.scope + ')' : '‚ùå NO');
                debugEl.innerHTML += '<p>' + swInfo + '</p>';
            }).catch(e => {
                debugEl.innerHTML += '<p>SW Error: ' + e.message + '</p>';
            });
        }
        
    } catch (e) {
        info.push('Error: ' + e.message);
    }
    
    debugEl.innerHTML = info.map(i => '<p>' + i + '</p>').join('');
}

// Run immediately and also on DOMContentLoaded
try {
    updateDebugInfo();
} catch(e) {
    console.error('Debug error:', e);
}
</script>
{% endblock %}
