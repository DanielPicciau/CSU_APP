{% extends 'base_new.html' %}
{% load static %}

{% block title %}Today - CSU Tracker{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/score-selector.css' %}">
<style>
    /* â”€â”€ Home screen refinements â”€â”€ */
    .home-greeting {
        padding: var(--space-2) 0 var(--space-5);
    }
    .home-greeting__date {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-size: var(--text-sm);
        color: var(--text-secondary);
        font-weight: var(--font-medium);
    }
    .home-greeting__date svg { color: var(--text-brand); flex-shrink: 0; }
    .home-greeting__title {
        font-size: var(--text-2xl);
        font-weight: var(--font-bold);
        color: var(--text-primary);
        margin: var(--space-2) 0 0;
        line-height: var(--leading-tight);
    }

    /* â”€â”€ Hero today card â”€â”€ */
    .hero-card {
        background: var(--surface-primary);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-2xl);
        overflow: hidden;
        margin-bottom: var(--space-6);
    }
    .hero-card__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-3) var(--space-5);
    }
    .hero-card__tag {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1-5);
        font-size: var(--text-xs);
        font-weight: var(--font-semibold);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
    }
    .hero-card__tag--logged {
        background: var(--color-success-50);
        color: var(--color-success-600);
    }
    .hero-card__tag--pending {
        background: var(--color-warning-50);
        color: var(--color-warning-600);
    }
    .hero-card__date-label {
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--text-tertiary);
    }

    /* Score display */
    .hero-score {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: var(--space-6) var(--space-5) var(--space-5);
    }
    .hero-score__ring {
        position: relative;
        width: 140px;
        height: 140px;
        margin-bottom: var(--space-5);
    }
    .hero-score__ring svg {
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
    }
    .hero-score__ring-track {
        fill: none;
        stroke: var(--bg-tertiary);
        stroke-width: 10;
    }
    .hero-score__ring-progress {
        fill: none;
        stroke-width: 10;
        stroke-linecap: round;
        transition: stroke-dasharray 0.6s ease, stroke 0.3s ease;
    }
    .hero-score__value {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .hero-score__number {
        font-family: var(--font-display);
        font-size: 3rem;
        font-weight: var(--font-bold);
        line-height: 1;
    }
    .hero-score__of {
        font-size: var(--text-sm);
        color: var(--text-tertiary);
        margin-top: var(--space-1);
    }
    .hero-score__title {
        font-size: var(--text-base);
        font-weight: var(--font-semibold);
        color: var(--text-primary);
        margin: 0;
    }
    .hero-score__breakdown {
        display: flex;
        align-items: center;
        gap: var(--space-4);
        margin-top: var(--space-3);
        font-size: var(--text-sm);
        color: var(--text-secondary);
    }
    .hero-score__breakdown-item {
        display: flex;
        align-items: center;
        gap: var(--space-1-5);
    }
    .hero-score__breakdown-dot {
        width: 8px;
        height: 8px;
        border-radius: var(--radius-full);
        flex-shrink: 0;
    }
    .hero-score__meta {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1-5);
        font-size: var(--text-xs);
        color: var(--text-secondary);
        margin-top: var(--space-3);
        padding: var(--space-1-5) var(--space-3);
        background: var(--bg-tertiary);
        border-radius: var(--radius-full);
    }
    .hero-score__meta svg { flex-shrink: 0; }
    .hero-score__note {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        text-align: left;
        width: 100%;
        padding: var(--space-3) var(--space-4);
        background: var(--bg-tertiary);
        border-radius: var(--radius-lg);
        margin-top: var(--space-3);
        line-height: var(--leading-relaxed);
    }
    .hero-score__updated {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        margin-top: var(--space-3);
    }

    /* Empty state */
    .hero-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: var(--space-8) var(--space-5) var(--space-6);
    }
    .hero-empty__illustration {
        width: 96px;
        height: 96px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-brand-subtle);
        border-radius: var(--radius-full);
        margin-bottom: var(--space-5);
    }
    .hero-empty__illustration svg {
        width: 48px;
        height: 48px;
        color: var(--text-brand);
    }
    .hero-empty__title {
        font-size: var(--text-lg);
        font-weight: var(--font-semibold);
        color: var(--text-primary);
        margin: 0 0 var(--space-1);
    }
    .hero-empty__text {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        margin: 0;
    }

    /* Footer actions */
    .hero-card__footer {
        padding: var(--space-4) var(--space-5);
        border-top: 1px solid var(--border-subtle);
    }

    /* â”€â”€ Quick log section â”€â”€ */
    .quick-log-section {
        background: var(--surface-primary);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-2xl);
        overflow: hidden;
        margin-bottom: var(--space-6);
    }
    .quick-log-section__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-4) var(--space-5);
        border-bottom: 1px solid var(--border-subtle);
    }
    .quick-log-section__title {
        font-size: var(--text-base);
        font-weight: var(--font-semibold);
        color: var(--text-primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }
    .quick-log-section__title svg { color: var(--text-brand); }
    .quick-log-section__badge {
        font-size: var(--text-xs);
        font-weight: var(--font-medium);
        color: var(--text-brand);
        background: var(--bg-brand-subtle);
        padding: var(--space-0-5) var(--space-2);
        border-radius: var(--radius-full);
    }
    .quick-log-section__body {
        padding: var(--space-5);
    }

    /* â”€â”€ Week chart â”€â”€ */
    .week-section {
        background: var(--surface-primary);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-2xl);
        overflow: hidden;
        margin-bottom: var(--space-5);
    }
    .week-section__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-4) var(--space-5);
    }
    .week-section__title {
        font-size: var(--text-base);
        font-weight: var(--font-semibold);
        color: var(--text-primary);
        margin: 0;
    }
    .week-section__uas7 {
        text-align: right;
    }
    .week-section__uas7-value {
        font-size: var(--text-2xl);
        font-weight: var(--font-bold);
        line-height: 1;
    }
    .week-section__uas7-label {
        font-size: 11px;
        color: var(--text-tertiary);
        font-weight: var(--font-medium);
    }
    .week-chart {
        padding: var(--space-3) var(--space-5) var(--space-5);
        position: relative;
    }
    .week-chart__grid {
        position: absolute;
        top: var(--space-3);
        left: var(--space-5);
        right: var(--space-5);
        height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        pointer-events: none;
    }
    .week-chart__grid-line {
        height: 1px;
        background: var(--border-subtle);
        width: 100%;
    }
    .week-chart__bars {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        gap: var(--space-2);
        height: 120px;
        position: relative;
        z-index: 1;
    }
    .week-chart__col {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100%;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
    }
    .week-chart__bar-wrap {
        flex: 1;
        width: 100%;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        align-items: center;
        position: relative;
    }
    .week-chart__bar {
        width: 100%;
        max-width: 36px;
        border-radius: var(--radius-lg) var(--radius-lg) var(--radius-sm) var(--radius-sm);
        transform: scaleY(0);
        transform-origin: bottom;
        animation: weekBarGrow 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        transition: filter 0.2s ease, box-shadow 0.2s ease;
        position: relative;
    }
    .week-chart__col:nth-child(1) .week-chart__bar { animation-delay: 0.05s; }
    .week-chart__col:nth-child(2) .week-chart__bar { animation-delay: 0.1s; }
    .week-chart__col:nth-child(3) .week-chart__bar { animation-delay: 0.15s; }
    .week-chart__col:nth-child(4) .week-chart__bar { animation-delay: 0.2s; }
    .week-chart__col:nth-child(5) .week-chart__bar { animation-delay: 0.25s; }
    .week-chart__col:nth-child(6) .week-chart__bar { animation-delay: 0.3s; }
    .week-chart__col:nth-child(7) .week-chart__bar { animation-delay: 0.35s; }
    @keyframes weekBarGrow {
        from { transform: scaleY(0); opacity: 0.5; }
        to { transform: scaleY(1); opacity: 1; }
    }
    .week-chart__col:active .week-chart__bar {
        filter: brightness(1.1);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .week-chart__bar--empty {
        height: 6px;
        background: var(--border-default);
        border-radius: var(--radius-sm);
        width: 60%;
        max-width: 24px;
        animation: none;
        transform: scaleY(1);
    }
    .week-chart__bar--future {
        height: 4px;
        background: var(--border-default);
        border-radius: var(--radius-sm);
        width: 60%;
        max-width: 24px;
        opacity: 0.25;
        animation: none;
        transform: scaleY(1);
        background: repeating-linear-gradient(
            90deg,
            var(--border-default) 0px,
            var(--border-default) 4px,
            transparent 4px,
            transparent 8px
        );
    }
    .week-chart__label {
        font-size: 11px;
        font-weight: var(--font-medium);
        color: var(--text-tertiary);
        margin-top: var(--space-2);
        text-align: center;
        transition: color 0.2s ease;
    }
    .week-chart__label--today {
        color: var(--text-brand);
        font-weight: var(--font-bold);
    }
    .week-chart__label--future {
        opacity: 0.4;
    }
    .week-chart__score-tip {
        font-size: 10px;
        font-weight: var(--font-bold);
        color: var(--text-secondary);
        margin-bottom: var(--space-1);
        line-height: 1;
        opacity: 0;
        animation: fadeInDown 0.3s ease forwards;
        animation-delay: 0.6s;
    }
    @keyframes fadeInDown {
        from { opacity: 0; transform: translateY(-4px); }
        to { opacity: 1; transform: translateY(0); }
    }
    /* Today indicator dot */
    .week-chart__today-dot {
        width: 5px;
        height: 5px;
        border-radius: 50%;
        background: var(--text-brand);
        margin-top: 3px;
    }
    .week-chart__severity {
        font-size: var(--text-xs);
        text-align: center;
        padding: var(--space-3) var(--space-4);
        margin: var(--space-3) var(--space-5) var(--space-4);
        border-radius: var(--radius-lg);
        font-weight: var(--font-medium);
    }
    .week-chart__severity--good {
        background: var(--color-success-50);
        color: var(--color-success-600);
    }
    .week-chart__severity--mild {
        background: var(--color-warning-50);
        color: var(--color-warning-600);
    }
    .week-chart__severity--moderate {
        background: color-mix(in srgb, var(--color-score-4) 12%, transparent);
        color: var(--color-score-4);
    }
    .week-chart__severity--severe {
        background: var(--color-error-50);
        color: var(--color-error-600);
    }
    .week-chart__severity--incomplete {
        background: var(--bg-tertiary);
        color: var(--text-tertiary);
    }

    /* â”€â”€ Stats row â”€â”€ */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-3);
        margin-bottom: var(--space-5);
    }
    .stat-card {
        background: var(--surface-primary);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        padding: var(--space-4) var(--space-4) var(--space-3);
        text-decoration: none;
        transition: var(--transition-all);
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    .stat-card:hover {
        border-color: var(--border-strong);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    .stat-card:active {
        transform: translateY(0);
    }
    .stat-card__icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-3);
    }
    .stat-card__icon--brand {
        background: var(--bg-brand-subtle);
        color: var(--text-brand);
    }
    .stat-card__icon--teal {
        background: var(--color-secondary-50);
        color: var(--color-secondary-600);
    }
    .stat-card__number {
        font-size: var(--text-3xl);
        font-weight: var(--font-bold);
        line-height: 1;
    }
    .stat-card__label {
        font-size: var(--text-xs);
        color: var(--text-secondary);
        margin-top: var(--space-1-5);
        line-height: var(--leading-snug);
    }

    /* â”€â”€ Reminder CTA â”€â”€ */
    .reminder-cta {
        background: linear-gradient(135deg, var(--color-primary-600) 0%, var(--color-primary-700) 100%);
        border-radius: var(--radius-2xl);
        padding: var(--space-5);
        margin-bottom: var(--space-5);
        overflow: hidden;
        position: relative;
    }
    .reminder-cta::before {
        content: '';
        position: absolute;
        top: -30%;
        right: -10%;
        width: 140px;
        height: 140px;
        background: rgba(255,255,255,0.08);
        border-radius: var(--radius-full);
    }
    .reminder-cta__inner {
        display: flex;
        align-items: flex-start;
        gap: var(--space-3);
        position: relative;
        z-index: 1;
    }
    .reminder-cta__icon {
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255,255,255,0.15);
        border-radius: var(--radius-lg);
        flex-shrink: 0;
    }
    .reminder-cta__icon svg { color: white; }
    .reminder-cta__title {
        font-weight: var(--font-semibold);
        color: white;
        margin: 0 0 var(--space-1);
        font-size: var(--text-base);
    }
    .reminder-cta__text {
        font-size: var(--text-sm);
        color: rgba(255,255,255,0.8);
        margin: 0 0 var(--space-3);
        line-height: var(--leading-relaxed);
    }
    .reminder-cta__btn {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1-5);
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        color: var(--color-primary-700);
        background: white;
        padding: var(--space-2) var(--space-4);
        border-radius: var(--radius-lg);
        text-decoration: none;
        transition: var(--transition-all);
    }
    .reminder-cta__btn:hover {
        background: var(--color-neutral-100);
        transform: translateY(-1px);
    }

    /* â”€â”€ Injection reminder banner â”€â”€ */
    .injection-banner {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-4) var(--space-5);
        border-radius: var(--radius-xl);
        margin-bottom: var(--space-5);
    }
    .injection-banner--due-soon {
        background: var(--color-warning-50, #FFFBEB);
        border: 1px solid var(--color-warning-200, #FDE68A);
    }
    .injection-banner--overdue {
        background: var(--color-error-50, #FEF2F2);
        border: 1px solid var(--color-error-200, #FECACA);
    }
    .injection-banner--today {
        background: var(--color-success-50, #ECFDF5);
        border: 1px solid var(--color-success-200, #A7F3D0);
    }
    .injection-banner__icon {
        flex-shrink: 0;
        width: 36px;
        height: 36px;
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .injection-banner--due-soon .injection-banner__icon { background: var(--color-warning-100, #FEF3C7); color: var(--color-warning-600, #D97706); }
    .injection-banner--overdue .injection-banner__icon { background: var(--color-error-100, #FEE2E2); color: var(--color-error-600, #DC2626); }
    .injection-banner--today .injection-banner__icon { background: var(--color-success-100, #D1FAE5); color: var(--color-success-600, #059669); }
    .injection-banner__body { flex: 1; min-width: 0; }
    .injection-banner__title {
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        margin: 0 0 var(--space-0-5);
    }
    .injection-banner--due-soon .injection-banner__title { color: var(--color-warning-800, #92400E); }
    .injection-banner--overdue .injection-banner__title { color: var(--color-error-800, #991B1B); }
    .injection-banner--today .injection-banner__title { color: var(--color-success-800, #065F46); }
    .injection-banner__text {
        font-size: var(--text-xs);
        margin: 0;
    }
    .injection-banner--due-soon .injection-banner__text { color: var(--color-warning-700, #B45309); }
    .injection-banner--overdue .injection-banner__text { color: var(--color-error-700, #B91C1C); }
    .injection-banner--today .injection-banner__text { color: var(--color-success-700, #047857); }
    .injection-banner__action {
        flex-shrink: 0;
    }
    .injection-banner__btn {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        font-size: var(--text-xs);
        font-weight: var(--font-semibold);
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-lg);
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: var(--transition-all);
    }
    .injection-banner--due-soon .injection-banner__btn { background: var(--color-warning-600, #D97706); color: white; }
    .injection-banner--overdue .injection-banner__btn { background: var(--color-error-600, #DC2626); color: white; }
    .injection-banner--today .injection-banner__btn { background: var(--color-success-600, #059669); color: white; }
    .injection-banner__btn:hover { opacity: 0.9; transform: translateY(-1px); }

    /* Injection modal */
    .injection-modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.4);
        z-index: 100;
        align-items: center;
        justify-content: center;
    }
    .injection-modal-overlay.active { display: flex; }
    .injection-modal {
        background: var(--surface-primary, #fff);
        border-radius: var(--radius-2xl);
        padding: var(--space-6);
        width: 90%;
        max-width: 360px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    }
    .injection-modal__title {
        font-size: var(--text-lg);
        font-weight: var(--font-bold);
        color: var(--text-primary);
        margin: 0 0 var(--space-2);
    }
    .injection-modal__subtitle {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        margin: 0 0 var(--space-5);
    }
    .injection-modal__input {
        width: 100%;
        padding: var(--space-3);
        border: 1px solid var(--border-default, #D1D5DB);
        border-radius: var(--radius-lg);
        font-size: var(--text-base);
        margin-bottom: var(--space-4);
        box-sizing: border-box;
    }
    .injection-modal__actions {
        display: flex;
        gap: var(--space-3);
    }
    .injection-modal__actions button {
        flex: 1;
        padding: var(--space-3);
        border-radius: var(--radius-lg);
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        cursor: pointer;
        border: none;
        transition: var(--transition-all);
    }
    .injection-modal__cancel {
        background: var(--surface-secondary, #F3F4F6);
        color: var(--text-secondary);
    }
    .injection-modal__save {
        background: var(--color-primary-600, #4F46E5);
        color: white;
    }
    .injection-modal__save:hover { opacity: 0.9; }
</style>
{% endblock %}

{% block header_title %}
    Today
{% endblock %}

{% block header_right %}
<a href="{% url 'accounts:profile' %}" class="btn btn--icon btn--ghost" aria-label="Profile">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
        <circle cx="12" cy="7" r="4"/>
    </svg>
</a>
{% endblock %}

{% block content %}
<div class="app-content">
    
    <!-- Date & Greeting -->
    <div class="home-greeting">
        <p class="home-greeting__date">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            {{ today|date:"l, F j, Y" }}
        </p>
        <h1 class="home-greeting__title">
            {% now "H" as current_hour %}
            {% if current_hour|add:0 < 12 %}Good morning{% if user.profile.display_name %}, {{ user.profile.display_name }}{% endif %} â˜€ï¸
            {% elif current_hour|add:0 < 17 %}Good afternoon{% if user.profile.display_name %}, {{ user.profile.display_name }}{% endif %} ðŸ‘‹
            {% else %}Good evening{% if user.profile.display_name %}, {{ user.profile.display_name }}{% endif %} ðŸŒ™
            {% endif %}
        </h1>
    </div>
    
    {% if next_injection and next_injection.is_due_soon %}
    <!-- Injection Reminder Banner -->
    <div class="injection-banner {% if next_injection.is_overdue %}injection-banner--overdue{% elif next_injection.days_until == 0 %}injection-banner--today{% else %}injection-banner--due-soon{% endif %}">
        <div class="injection-banner__icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 2l-2 2m0 0l-6 6-2 2-4 4-2 2 2 2 2-2 4-4 2-2 6-6m-8 8l2 2"/>
                <path d="M15 5l4 4"/>
            </svg>
        </div>
        <div class="injection-banner__body">
            {% if next_injection.is_overdue %}
            <p class="injection-banner__title">Injection overdue</p>
            <p class="injection-banner__text">Your {{ next_injection.medication_name }} was due {{ next_injection.date|date:"d M" }}</p>
            {% elif next_injection.days_until == 0 %}
            <p class="injection-banner__title">Injection due today</p>
            <p class="injection-banner__text">{{ next_injection.medication_name }} injection is scheduled for today</p>
            {% elif next_injection.days_until == 1 %}
            <p class="injection-banner__title">Injection due tomorrow</p>
            <p class="injection-banner__text">{{ next_injection.medication_name }} Â· {{ next_injection.date|date:"l, d M" }}</p>
            {% else %}
            <p class="injection-banner__title">Injection in {{ next_injection.days_until }} days</p>
            <p class="injection-banner__text">{{ next_injection.medication_name }} Â· {{ next_injection.date|date:"l, d M" }}</p>
            {% endif %}
        </div>
        <div class="injection-banner__action">
            <button type="button" class="injection-banner__btn" onclick="openInjectionModal()">
                Log injection
            </button>
        </div>
    </div>

    <!-- Injection date modal -->
    <div class="injection-modal-overlay" id="injection-modal">
        <div class="injection-modal">
            <h3 class="injection-modal__title">Record injection</h3>
            <p class="injection-modal__subtitle">When did you take (or plan to take) your {{ next_injection.medication_name }} injection?</p>
            <input type="date" class="injection-modal__input" id="injection-date-input"
                   value="{{ today|date:'Y-m-d' }}">
            <div class="injection-modal__actions">
                <button type="button" class="injection-modal__cancel" onclick="closeInjectionModal()">Cancel</button>
                <button type="button" class="injection-modal__save" onclick="saveInjectionDate()">Save</button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Today's Entry Card -->
    <div class="hero-card" id="today-card" data-has-entry="{{ today_entry|yesno:'true,false' }}">
        <div class="hero-card__header">
            <span class="hero-card__date-label">Today's Score</span>
            {% if today_entry %}
            <span class="hero-card__tag hero-card__tag--logged">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                Logged
            </span>
            {% else %}
            <span class="hero-card__tag hero-card__tag--pending">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/></svg>
                Pending
            </span>
            {% endif %}
        </div>
        
        {% if today_entry %}
        <!-- Entry Exists - Show Score Ring -->
        <div class="hero-score" id="score-display">
            <div class="hero-score__ring" id="score-ring">
                <svg viewBox="0 0 140 140">
                    <circle class="hero-score__ring-track" cx="70" cy="70" r="60"/>
                    <circle class="hero-score__ring-progress"
                        cx="70" cy="70" r="60"
                        stroke="var(--color-score-{{ today_entry.score }})"
                        style="stroke-dasharray: {% widthratio today_entry.score 6 377 %} 377;"
                    />
                </svg>
                <div class="hero-score__value">
                    <span class="hero-score__number" id="score-number" style="color: var(--color-score-{{ today_entry.score }});">{{ today_entry.score }}</span>
                    <span class="hero-score__of">of 6</span>
                </div>
            </div>
            <h2 class="hero-score__title">Today's UAS Score</h2>
            <div class="hero-score__breakdown">
                <span class="hero-score__breakdown-item">
                    <span class="hero-score__breakdown-dot" style="background: var(--color-score-{% widthratio today_entry.hive_count_score 3 6 %});"></span>
                    Hives {{ today_entry.hive_count_score }}/3
                </span>
                <span class="hero-score__breakdown-item">
                    <span class="hero-score__breakdown-dot" style="background: var(--color-score-{% widthratio today_entry.itch_score 3 6 %});"></span>
                    Itch {{ today_entry.itch_score }}/3
                </span>
            </div>
            
            {% if today_entry.took_antihistamine %}
            <span class="hero-score__meta">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                Took antihistamine
            </span>
            {% endif %}
            
            {% if today_entry.notes %}
            <p class="hero-score__note">{{ today_entry.notes|truncatewords:30 }}</p>
            {% endif %}
            
            <p class="hero-score__updated">
                Updated {{ today_entry.updated_at|timesince }} ago
            </p>
        </div>
        {% else %}
        <!-- No Entry - Inviting Empty State -->
        <div class="hero-empty" id="empty-state">
            <div class="hero-empty__illustration">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                    <line x1="12" y1="14" x2="12" y2="18"/>
                    <line x1="10" y1="16" x2="14" y2="16"/>
                </svg>
            </div>
            <h2 class="hero-empty__title">No entry yet</h2>
            <p class="hero-empty__text">How are your symptoms today?</p>
        </div>
        {% endif %}
        
        <div class="hero-card__footer">
            {% if today_entry %}
            <a href="{% url 'tracking:log_entry' %}" class="btn btn--secondary btn--full">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                Edit Today's Entry
            </a>
            {% else %}
            <a href="{% url 'tracking:log_entry' %}" class="btn btn--primary btn--full btn--lg">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Log Today's Score
            </a>
            {% endif %}
        </div>
    </div>
    
    <!-- Quick Log (if no entry) -->
    {% if not today_entry %}
    <div class="quick-log-section" id="quick-log-card">
        <div class="quick-log-section__header">
            <h3 class="quick-log-section__title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                </svg>
                Quick Log
            </h3>
            <span class="quick-log-section__badge">~5 seconds</span>
        </div>
        <div class="quick-log-section__body">
            <form id="quick-log-form" method="post" action="{% url 'tracking:log_entry' %}">
                {% csrf_token %}
                <input type="hidden" name="structured_quick_mode" value="1">
                
                <!-- Hives Row -->
                <div class="quick-row mb-4">
                    <div class="quick-row__header">
                        <span class="quick-row__label">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="quick-row__icon">
                                <circle cx="12" cy="12" r="3"/>
                                <circle cx="6" cy="8" r="2"/>
                                <circle cx="18" cy="8" r="2"/>
                                <circle cx="8" cy="16" r="2"/>
                                <circle cx="16" cy="16" r="2"/>
                            </svg>
                            Hives
                        </span>
                        <span class="quick-row__selected" id="hives-selected">Select</span>
                    </div>
                    <div class="quick-row__options" role="radiogroup" aria-label="Hive severity">
                        <label class="quick-option quick-option--0">
                            <input type="radio" name="hive_count_score" value="0" class="quick-option__input" required>
                            <span class="quick-option__btn">
                                <span class="quick-option__num">0</span>
                                <span class="quick-option__text">None</span>
                            </span>
                        </label>
                        <label class="quick-option quick-option--1">
                            <input type="radio" name="hive_count_score" value="1" class="quick-option__input">
                            <span class="quick-option__btn">
                                <span class="quick-option__num">1</span>
                                <span class="quick-option__text">Mild</span>
                            </span>
                        </label>
                        <label class="quick-option quick-option--2">
                            <input type="radio" name="hive_count_score" value="2" class="quick-option__input">
                            <span class="quick-option__btn">
                                <span class="quick-option__num">2</span>
                                <span class="quick-option__text">Mod</span>
                            </span>
                        </label>
                        <label class="quick-option quick-option--3">
                            <input type="radio" name="hive_count_score" value="3" class="quick-option__input">
                            <span class="quick-option__btn">
                                <span class="quick-option__num">3</span>
                                <span class="quick-option__text">Severe</span>
                            </span>
                        </label>
                    </div>
                </div>
                
                <!-- Itchiness Row -->
                <div class="quick-row mb-4">
                    <div class="quick-row__header">
                        <span class="quick-row__label">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="quick-row__icon">
                                <path d="M14 4l-4 4 4 4"/>
                                <path d="M10 8l4 4-4 4"/>
                                <path d="M6 12h12"/>
                            </svg>
                            Itchiness
                        </span>
                        <span class="quick-row__selected" id="itch-selected">Select</span>
                    </div>
                    <div class="quick-row__options" role="radiogroup" aria-label="Itch severity">
                        <label class="quick-option quick-option--0">
                            <input type="radio" name="itch_score" value="0" class="quick-option__input" required>
                            <span class="quick-option__btn">
                                <span class="quick-option__num">0</span>
                                <span class="quick-option__text">None</span>
                            </span>
                        </label>
                        <label class="quick-option quick-option--1">
                            <input type="radio" name="itch_score" value="1" class="quick-option__input">
                            <span class="quick-option__btn">
                                <span class="quick-option__num">1</span>
                                <span class="quick-option__text">Mild</span>
                            </span>
                        </label>
                        <label class="quick-option quick-option--2">
                            <input type="radio" name="itch_score" value="2" class="quick-option__input">
                            <span class="quick-option__btn">
                                <span class="quick-option__num">2</span>
                                <span class="quick-option__text">Mod</span>
                            </span>
                        </label>
                        <label class="quick-option quick-option--3">
                            <input type="radio" name="itch_score" value="3" class="quick-option__input">
                            <span class="quick-option__btn">
                                <span class="quick-option__num">3</span>
                                <span class="quick-option__text">Severe</span>
                            </span>
                        </label>
                    </div>
                </div>
                
                <!-- Total Score Display -->
                <div class="quick-total" id="quick-total" style="display: none;" aria-live="polite" aria-atomic="true">
                    <span class="quick-total__label">Today's Score</span>
                    <span class="quick-total__value" id="quick-total-value">0</span>
                    <span class="quick-total__max">/6</span>
                </div>
                
                <button type="submit" id="quick-log-btn" class="btn btn--primary btn--full mt-4" disabled>
                    Save Score
                </button>
            </form>
        </div>
    </div>
    {% endif %}
    
    <!-- Week Overview -->
    <div class="week-section">
        <div class="week-section__header">
            <h3 class="week-section__title">{% if treatment_cycle %}Week {{ treatment_cycle.week_number }}{% if treatment_cycle.is_overflow %} <span style="color: var(--color-warning, #f59e0b); font-size: var(--text-xs);" title="Past expected injection cycle">âš  overflow</span>{% endif %}{% else %}This Week{% endif %}</h3>
            <div class="week-section__uas7">
                <div class="week-section__uas7-value {% if uas7_complete %}text-brand{% else %}text-tertiary{% endif %}">{{ uas7_score }}</div>
                <div class="week-section__uas7-label">UAS7{% if not uas7_complete %} (partial){% endif %}</div>
            </div>
        </div>
        <div class="week-chart">
            <!-- Subtle grid lines for visual reference -->
            <div class="week-chart__grid" aria-hidden="true">
                <div class="week-chart__grid-line"></div>
                <div class="week-chart__grid-line"></div>
                <div class="week-chart__grid-line"></div>
            </div>
            <div class="week-chart__bars" role="img" aria-label="Weekly score chart showing scores for 7 days">
                {% for day in chart_data %}
                <div class="week-chart__col" {% if day.has_entry %}role="button" tabindex="0" aria-label="{{ day.date|date:'l, M j' }}: Score {{ day.score }} of 6"{% endif %}>
                    <div class="week-chart__bar-wrap">
                        {% if day.is_future %}
                        <div class="week-chart__bar--future"
                            title="{{ day.date|date:'M j' }}: Upcoming"
                            aria-label="{{ day.date|date:'l' }}: Upcoming"></div>
                        {% elif day.has_entry %}
                        <span class="week-chart__score-tip">{{ day.score }}</span>
                        <div class="week-chart__bar"
                            style="height: {% widthratio day.score 6 96 %}px; min-height: 10px; background: linear-gradient(180deg, var(--color-score-{{ day.score }}), color-mix(in srgb, var(--color-score-{{ day.score }}) 80%, black));"
                            title="{{ day.date|date:'M j' }}: Score {{ day.score }}/6"
                            aria-label="{{ day.date|date:'l' }}: Score {{ day.score }} of 6"></div>
                        {% else %}
                        <div class="week-chart__bar--empty"
                            title="{{ day.date|date:'M j' }}: No entry"
                            aria-label="{{ day.date|date:'l' }}: No entry"></div>
                        {% endif %}
                    </div>
                    <span class="week-chart__label {% if day.date == today %}week-chart__label--today{% elif day.is_future %}week-chart__label--future{% endif %}">
                        {{ day.date|date:"D" }}
                    </span>
                    {% if day.date == today %}
                    <span class="week-chart__today-dot" aria-hidden="true"></span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% if uas7_complete %}
        <div class="week-chart__severity {% if uas7_score <= 6 %}week-chart__severity--good{% elif uas7_score <= 15 %}week-chart__severity--mild{% elif uas7_score <= 27 %}week-chart__severity--moderate{% else %}week-chart__severity--severe{% endif %}">
            {% if uas7_score <= 6 %}âœ“ Well controlled this week
            {% elif uas7_score <= 15 %}Mild activity this week
            {% elif uas7_score <= 27 %}Moderate activity â€” tracking helps you and your doctor
            {% else %}High activity â€” sharing this with your doctor can help find relief
            {% endif %}
        </div>
        {% else %}
        <div class="week-chart__severity week-chart__severity--incomplete">
            Log all 7 days for your complete UAS7 score
        </div>
        {% endif %}
    </div>
    
    <!-- Stats Row -->
    <div class="stats-grid">
        <a href="{% url 'tracking:insights' %}" class="stat-card">
            <div class="stat-card__icon stat-card__icon--brand">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                </svg>
            </div>
            <div class="stat-card__number text-brand">{{ logged_in_30_days }}</div>
            <div class="stat-card__label">of last 30 days logged</div>
        </a>
        <a href="{% url 'tracking:history' %}" class="stat-card">
            <div class="stat-card__icon stat-card__icon--teal">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 8v4l3 3"/>
                    <circle cx="12" cy="12" r="9"/>
                </svg>
            </div>
            <div class="stat-card__number text-primary">{{ total_entries|default:0 }}</div>
            <div class="stat-card__label">Total Entries</div>
        </a>
    </div>
    
    <!-- Reminder CTA - Only show if: 1) notifications not set up AND 2) no entry for today -->
    {% if not has_notification_setup and not today_entry %}
    <div class="reminder-cta" id="reminder-cta-card">
        <div class="reminder-cta__inner">
            <div class="reminder-cta__icon">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                </svg>
            </div>
            <div>
                <h3 class="reminder-cta__title">Never forget to log</h3>
                <p class="reminder-cta__text">
                    Set up daily reminders to build your tracking habit.
                </p>
                <a href="{% url 'notifications:settings' %}" class="reminder-cta__btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    </svg>
                    Enable Reminders
                </a>
            </div>
        </div>
    </div>
    {% endif %}
    
</div>

{% block extra_js %}
<script src="{% static 'js/score-selector.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Structured quick log form handling
    const quickForm = document.getElementById('quick-log-form');
    const quickBtn = document.getElementById('quick-log-btn');
    const quickTotal = document.getElementById('quick-total');
    const quickTotalValue = document.getElementById('quick-total-value');
    const hivesSelected = document.getElementById('hives-selected');
    const itchSelected = document.getElementById('itch-selected');
    
    if (quickForm && quickBtn) {
        const hivesRadios = quickForm.querySelectorAll('input[name="hive_count_score"]');
        const itchRadios = quickForm.querySelectorAll('input[name="itch_score"]');
        
        const SEVERITY_LABELS = ['None', 'Mild', 'Moderate', 'Severe'];
        
        function updateTotal() {
            const hivesChecked = quickForm.querySelector('input[name="hive_count_score"]:checked');
            const itchChecked = quickForm.querySelector('input[name="itch_score"]:checked');
            
            // Update selection displays
            if (hivesChecked && hivesSelected) {
                hivesSelected.textContent = SEVERITY_LABELS[parseInt(hivesChecked.value)];
                hivesSelected.classList.add('quick-row__selected--active');
            }
            if (itchChecked && itchSelected) {
                itchSelected.textContent = SEVERITY_LABELS[parseInt(itchChecked.value)];
                itchSelected.classList.add('quick-row__selected--active');
            }
            
            // Enable submit button and show total only when both are selected
            if (hivesChecked && itchChecked) {
                const total = parseInt(hivesChecked.value) + parseInt(itchChecked.value);
                quickBtn.disabled = false;
                quickBtn.textContent = `Save Score: ${total}/6`;
                
                // Show total display
                if (quickTotal && quickTotalValue) {
                    quickTotal.style.display = 'flex';
                    quickTotalValue.textContent = total;
                    quickTotalValue.className = 'quick-total__value quick-total__value--score-' + total;
                }
            } else {
                quickBtn.disabled = true;
                quickBtn.textContent = 'Save Score';
            }
        }
        
        // Add listeners to all radios
        [...hivesRadios, ...itchRadios].forEach(radio => {
            radio.addEventListener('change', function() {
                // Haptic feedback
                if ('vibrate' in navigator) {
                    navigator.vibrate(10);
                }
                updateTotal();
            });
        });
        
        quickForm.addEventListener('submit', function(e) {
            const hivesChecked = quickForm.querySelector('input[name="hive_count_score"]:checked');
            const itchChecked = quickForm.querySelector('input[name="itch_score"]:checked');
            
            if (!hivesChecked || !itchChecked) {
                e.preventDefault();
                if (typeof CSU !== 'undefined' && CSU.Toast) {
                    CSU.Toast.warning('Please select both Hives and Itchiness');
                }
                return;
            }
            
            quickBtn.disabled = true;
            quickBtn.innerHTML = '<span class="spinner spinner--sm" style="border-top-color: white;"></span> Saving...';
        });
    }
    
    // Auto-refresh if entry is stale - show toast reminder once (not repeated)
    const todayCard = document.getElementById('today-card');
    if (todayCard) {
        const hasEntry = todayCard.dataset.hasEntry === 'true';
        const reminderShownKey = 'csu_evening_reminder_' + new Date().toISOString().split('T')[0];
        
        // If no entry and it's late in the day, show ONE reminder (check localStorage)
        const hour = new Date().getHours();
        if (!hasEntry && hour >= 18 && hour < 22 && !localStorage.getItem(reminderShownKey)) {
            setTimeout(() => {
                if (typeof CSU !== 'undefined' && CSU.Toast) {
                    CSU.Toast.info('Don\'t forget to log your symptoms before bed!', 'Evening Reminder');
                }
                localStorage.setItem(reminderShownKey, 'true');
            }, 3000);
        }
    }
});

function openInjectionModal() {
    var overlay = document.getElementById('injection-modal');
    if (overlay) overlay.classList.add('active');
}
function closeInjectionModal() {
    var overlay = document.getElementById('injection-modal');
    if (overlay) overlay.classList.remove('active');
}
function saveInjectionDate() {
    var dateInput = document.getElementById('injection-date-input');
    if (!dateInput || !dateInput.value) return;
    var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        // Fallback: get from cookie
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var c = cookies[i].trim();
            if (c.indexOf('csrftoken=') === 0) {
                csrfToken = c.substring('csrftoken='.length);
                break;
            }
        }
    } else {
        csrfToken = csrfToken.value;
    }
    var medId = {{ next_injection.medication_id|default:"0"|escapejs }};
    fetch('/api/accounts/injection/record/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            medication_id: medId,
            injection_date: dateInput.value
        })
    }).then(function(resp) {
        if (resp.ok) { window.location.reload(); }
        else { resp.json().then(function(d) { alert(d.detail || d.injection_date || 'Error recording injection.'); }); }
    }).catch(function() { alert('Network error. Please try again.'); });
}
</script>
{% endblock %}
{% endblock %}
