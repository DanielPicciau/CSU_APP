{% extends 'base_new.html' %}
{% load static %}
{% load tracking_tags %}

{% block title %}Insights - CSU Tracker{% endblock %}

{% block extra_head %}
<style>
/* Insights-specific styles */
.insight-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-xl);
    padding: var(--space-5);
    margin-bottom: var(--space-4);
}
.insight-card__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-4);
}
.insight-card__title {
    font-size: var(--text-base);
    font-weight: 600;
    color: var(--text-primary);
}
.insight-card__subtitle {
    font-size: var(--text-sm);
    color: var(--text-secondary);
}

.stat-hero {
    text-align: center;
    padding: var(--space-6) var(--space-4);
}
.stat-hero__value {
    font-size: 3.5rem;
    font-weight: 800;
    line-height: 1;
    background: linear-gradient(135deg, var(--color-primary-500), var(--color-secondary-500));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
.stat-hero__label {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    margin-top: var(--space-2);
}

.stat-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-3);
}
.stat-item {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    text-align: center;
}
.stat-item__value {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--text-primary);
}
.stat-item__label {
    font-size: var(--text-xs);
    color: var(--text-secondary);
    margin-top: var(--space-1);
}
.stat-item--highlight .stat-item__value {
    color: var(--color-primary-600);
}
.stat-item--success .stat-item__value {
    color: var(--color-success-600);
}
.stat-item--warning .stat-item__value {
    color: var(--color-warning-600);
}

.progress-ring {
    position: relative;
    width: 120px;
    height: 120px;
    margin: 0 auto;
}
.progress-ring__svg {
    transform: rotate(-90deg);
}
.progress-ring__circle {
    fill: none;
    stroke: var(--bg-tertiary);
    stroke-width: 8;
}
.progress-ring__progress {
    fill: none;
    stroke: var(--color-primary-500);
    stroke-width: 8;
    stroke-linecap: round;
    transition: stroke-dashoffset 0.5s ease;
}
.progress-ring__text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}
.progress-ring__value {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--text-primary);
}
.progress-ring__label {
    font-size: var(--text-xs);
    color: var(--text-secondary);
}

.trend-chart {
    height: 180px;
    position: relative;
    padding: var(--space-4) 0;
}
.trend-chart__svg {
    width: 100%;
    height: 100%;
}
.trend-chart__line {
    fill: none;
    stroke: var(--color-primary-500);
    stroke-width: 2.5;
    stroke-linecap: round;
    stroke-linejoin: round;
}
.trend-chart__area {
    fill: url(#gradient);
    opacity: 0.15;
}
.trend-chart__point {
    fill: var(--color-primary-500);
    stroke: white;
    stroke-width: 2;
}
.trend-chart__grid-line {
    stroke: var(--border-subtle);
    stroke-dasharray: 4 4;
}
.trend-chart__label {
    fill: var(--text-tertiary);
    font-size: 10px;
}

.average-bars {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}
.average-bar {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}
.average-bar__label {
    width: 80px;
    font-size: var(--text-sm);
    color: var(--text-secondary);
    flex-shrink: 0;
}
.average-bar__track {
    flex: 1;
    height: 8px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-full);
    overflow: hidden;
}
.average-bar__fill {
    height: 100%;
    border-radius: var(--radius-full);
    transition: width 0.5s ease;
}
.average-bar__value {
    width: 40px;
    text-align: right;
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--text-primary);
    flex-shrink: 0;
}

.week-comparison {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-2);
}
.week-block {
    text-align: center;
    padding: var(--space-3);
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
}
.week-block--current {
    background: var(--color-primary-50);
    border: 2px solid var(--color-primary-500);
}
[data-theme="dark"] .week-block--current {
    background: var(--color-primary-900);
}
.week-block__score {
    font-size: var(--text-xl);
    font-weight: 700;
}
.week-block__label {
    font-size: var(--text-xs);
    color: var(--text-secondary);
    margin-top: var(--space-1);
}
.week-block__change {
    font-size: var(--text-xs);
    margin-top: var(--space-1);
}
.week-block__change--up { color: var(--color-error-500); }
.week-block__change--down { color: var(--color-success-500); }
.week-block__change--same { color: var(--text-tertiary); }

.period-toggle {
    display: inline-flex;
    background: var(--bg-secondary);
    border-radius: var(--radius-full);
    padding: var(--space-1);
    gap: var(--space-1);
}
.period-toggle__btn {
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--text-secondary);
    border: none;
    background: transparent;
    cursor: pointer;
    transition: all var(--transition-fast);
}
.period-toggle__btn--active {
    background: var(--bg-primary);
    color: var(--text-primary);
    box-shadow: var(--shadow-sm);
}
.period-toggle__btn--disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

.history-limit-banner {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-3) var(--space-4);
    background: var(--color-warning-50);
    border: 1px solid var(--color-warning-200);
    border-radius: var(--radius-lg);
    margin: 0 auto var(--space-4);
    font-size: var(--text-sm);
    color: var(--text-secondary);
    max-width: 520px;
}
[data-theme="dark"] .history-limit-banner {
    background: rgba(245, 158, 11, 0.1);
    border-color: rgba(245, 158, 11, 0.3);
}
@media (prefers-color-scheme: dark) {
    :root:not([data-theme="light"]) .history-limit-banner {
        background: rgba(245, 158, 11, 0.1);
        border-color: rgba(245, 158, 11, 0.3);
    }
}

.disclaimer-text {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
    text-align: center;
    padding: var(--space-4);
    margin-top: var(--space-4);
    border-top: 1px solid var(--border-subtle);
}
</style>
{% endblock %}

{% block header_left %}
<a href="{% url 'tracking:today' %}" class="btn btn--icon btn--ghost" aria-label="Back to today">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
    </svg>
</a>
{% endblock %}

{% block header_title %}Insights{% endblock %}

{% block header_right %}
<a href="{% url 'tracking:history' %}" class="btn btn--icon btn--ghost" aria-label="View history">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
        <line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
    </svg>
</a>
{% endblock %}

{% block content %}
<div class="app-content">
    
    <!-- Period Toggle -->
    <div class="text-center mb-5 fade-in">
        <div class="period-toggle">
            <a href="?period=7" class="period-toggle__btn {% if period == 7 %}period-toggle__btn--active{% endif %}">7 days</a>
            <a href="?period=30" class="period-toggle__btn {% if period == 30 %}period-toggle__btn--active{% endif %}">30 days</a>
            <a href="{% if history_limited %}#{% else %}?period=90{% endif %}" class="period-toggle__btn {% if period == 90 %}period-toggle__btn--active{% endif %} {% if history_limited %}period-toggle__btn--disabled{% endif %}">90 days</a>
        </div>
    </div>

    {% if history_limited %}
    <div class="history-limit-banner fade-in">
        Free tier insights are limited to the last {{ history_limit_days }} days.
        <a href="{% url 'subscriptions:premium' %}" style="margin-left: 6px; font-weight: 600; text-decoration: underline;">Upgrade</a>
    </div>
    {% endif %}
    
    <!-- Adherence Card -->
    <div class="insight-card fade-in">
        <div class="insight-card__header">
            <div>
                <h2 class="insight-card__title">Tracking Adherence</h2>
                <p class="insight-card__subtitle">Last {{ period }} days</p>
            </div>
        </div>
        
        <div class="flex items-center justify-around">
            <!-- Progress Ring -->
            <div class="progress-ring">
                <svg class="progress-ring__svg" width="120" height="120" viewBox="0 0 120 120">
                    <circle class="progress-ring__circle" cx="60" cy="60" r="52"/>
                    <circle 
                        class="progress-ring__progress" 
                        cx="60" cy="60" r="52"
                        stroke-dasharray="327"
                        stroke-dashoffset="{{ adherence_offset }}"
                    />
                </svg>
                <div class="progress-ring__text">
                    <div class="progress-ring__value">{{ adherence_pct|floatformat:0 }}%</div>
                    <div class="progress-ring__label">logged</div>
                </div>
            </div>
            
            <div class="stat-grid" style="flex: 1; max-width: 180px;">
                <div class="stat-item stat-item--highlight">
                    <div class="stat-item__value">{{ logged_days }}</div>
                    <div class="stat-item__label">Logged</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__value">{{ missing_days }}</div>
                    <div class="stat-item__label">Missing</div>
                </div>
            </div>
        </div>
        
        {% if missing_days > 0 %}
        <div class="mt-4 text-center">
            <a href="{% url 'tracking:history' %}?show=missing&days={{ period }}" class="btn btn--secondary btn--sm">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Fill {{ missing_days }} missing {% if missing_days == 1 %}day{% else %}days{% endif %}
            </a>
        </div>
        {% endif %}
    </div>
    
    <!-- Logging Stats Card -->
    <div class="insight-card slide-up" style="animation-delay: 0.1s;">
        <div class="insight-card__header">
            <h2 class="insight-card__title">Your Logging</h2>
        </div>
        
        <div class="stat-grid">
            <div class="stat-item stat-item--highlight">
                <div class="stat-item__value">{{ logged_days }}</div>
                <div class="stat-item__label">Days in Period</div>
            </div>
            <div class="stat-item">
                <div class="stat-item__value">{{ total_entries }}</div>
                <div class="stat-item__label">All-Time Entries</div>
            </div>
        </div>
    </div>
    
    <!-- Score Trend Chart -->
    <div class="insight-card slide-up" style="animation-delay: 0.2s;">
        <div class="insight-card__header">
            <div>
                <h2 class="insight-card__title">Score Trend</h2>
                <p class="insight-card__subtitle">Daily scores over time</p>
            </div>
        </div>
        
        <div class="trend-chart" id="trend-chart">
            <svg class="trend-chart__svg" viewBox="0 0 {{ chart_width }} 150" preserveAspectRatio="none">
                <defs>
                    <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color: var(--color-primary-500);"/>
                        <stop offset="100%" style="stop-color: var(--color-primary-500); stop-opacity: 0;"/>
                    </linearGradient>
                </defs>
                
                <!-- Grid lines -->
                <line class="trend-chart__grid-line" x1="0" y1="25" x2="{{ chart_width }}" y2="25"/>
                <line class="trend-chart__grid-line" x1="0" y1="75" x2="{{ chart_width }}" y2="75"/>
                <line class="trend-chart__grid-line" x1="0" y1="125" x2="{{ chart_width }}" y2="125"/>
                
                <!-- Y-axis labels -->
                <text class="trend-chart__label" x="5" y="30">6</text>
                <text class="trend-chart__label" x="5" y="80">3</text>
                <text class="trend-chart__label" x="5" y="130">0</text>
                
                {% if chart_path %}
                <!-- Area fill -->
                <path class="trend-chart__area" d="{{ chart_area_path }}"/>
                
                <!-- Line -->
                <path class="trend-chart__line" d="{{ chart_path }}"/>
                
                <!-- Points -->
                {% for point in chart_points %}
                <circle class="trend-chart__point" cx="{{ point.x }}" cy="{{ point.y }}" r="4"/>
                {% endfor %}
                {% else %}
                <!-- No data message -->
                <text x="150" y="75" text-anchor="middle" fill="var(--text-tertiary)" font-size="12">
                    {% if logged_days == 0 %}
                    No entries yet - log your first day!
                    {% elif logged_days == 1 %}
                    Log one more day to see trends
                    {% else %}
                    Not enough data to show trend
                    {% endif %}
                </text>
                {% endif %}
            </svg>
        </div>
    </div>
    
    <!-- Averages Card -->
    <div class="insight-card slide-up" style="animation-delay: 0.3s;">
        <div class="insight-card__header">
            <div>
                <h2 class="insight-card__title">Score Averages</h2>
                <p class="insight-card__subtitle">Based on {{ logged_days }} logged {% if logged_days == 1 %}day{% else %}days{% endif %}</p>
            </div>
        </div>
        
        <div class="average-bars">
            <div class="average-bar">
                <span class="average-bar__label">Total Score</span>
                <div class="average-bar__track">
                    <div class="average-bar__fill" style="width: {{ avg_score_pct }}%; background: linear-gradient(90deg, var(--color-score-0), var(--color-score-3), var(--color-score-6));"></div>
                </div>
                <span class="average-bar__value">{{ avg_score|floatformat:1 }}</span>
            </div>
            <div class="average-bar">
                <span class="average-bar__label">Itch</span>
                <div class="average-bar__track">
                    <div class="average-bar__fill" style="width: {{ avg_itch_pct }}%; background: var(--color-primary-500);"></div>
                </div>
                <span class="average-bar__value">{{ avg_itch|floatformat:1 }}</span>
            </div>
            <div class="average-bar">
                <span class="average-bar__label">Hives</span>
                <div class="average-bar__track">
                    <div class="average-bar__fill" style="width: {{ avg_hives_pct }}%; background: var(--color-secondary-500);"></div>
                </div>
                <span class="average-bar__value">{{ avg_hives|floatformat:1 }}</span>
            </div>
        </div>
        
        <div class="stat-grid mt-5">
            <div class="stat-item">
                <div class="stat-item__value">{{ best_score }}</div>
                <div class="stat-item__label">Best Day</div>
            </div>
            <div class="stat-item">
                <div class="stat-item__value">{{ worst_score }}</div>
                <div class="stat-item__label">Worst Day</div>
            </div>
        </div>
    </div>
    
    <!-- Weekly UAS7 Comparison -->
    <div class="insight-card slide-up" style="animation-delay: 0.4s;">
        <div class="insight-card__header">
            <div>
                <h2 class="insight-card__title">Weekly UAS7</h2>
                <p class="insight-card__subtitle">Last 4 weeks comparison</p>
            </div>
        </div>
        
        <div class="week-comparison">
            {% for week in weekly_scores %}
            <div class="week-block {% if forloop.first %}week-block--current{% endif %}">
                <div class="week-block__score" style="color: {% if week.uas7 <= 6 %}var(--color-score-0){% elif week.uas7 <= 15 %}var(--color-score-2){% elif week.uas7 <= 27 %}var(--color-score-4){% else %}var(--color-score-6){% endif %};">
                    {% if week.complete %}{{ week.uas7 }}{% else %}{{ week.uas7 }}*{% endif %}
                </div>
                <div class="week-block__label">
                    {% if forloop.first %}This week{% else %}{{ week.label }}{% endif %}
                </div>
                {% if not forloop.first and week.change is not None %}
                <div class="week-block__change {% if week.change > 0 %}week-block__change--up{% elif week.change < 0 %}week-block__change--down{% else %}week-block__change--same{% endif %}">
                    {% if week.change > 0 %}â†‘{% elif week.change < 0 %}â†“{% else %}â†’{% endif %} {{ week.change|abs }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        
        <p class="text-xs text-tertiary text-center mt-3">* Incomplete week</p>
    </div>
    
    <!-- Antihistamine Stats -->
    {% if antihistamine_days > 0 %}
    <div class="insight-card slide-up" style="animation-delay: 0.5s;">
        <div class="insight-card__header">
            <div>
                <h2 class="insight-card__title">Antihistamine Usage</h2>
                <p class="insight-card__subtitle">Last {{ period }} days</p>
            </div>
        </div>
        
        <div class="stat-grid">
            <div class="stat-item">
                <div class="stat-item__value">{{ antihistamine_days }}</div>
                <div class="stat-item__label">Days Taken</div>
            </div>
            <div class="stat-item">
                <div class="stat-item__value">{{ antihistamine_pct|floatformat:0 }}%</div>
                <div class="stat-item__label">Of Logged Days</div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Export Data Card - Enhanced for NHS -->
    <div class="insight-card slide-up" style="animation-delay: 0.5s; background: linear-gradient(135deg, #005EB8 0%, #003087 100%); border: none;">
        <div class="insight-card__header" style="border: none;">
            <div>
                <span style="display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.2); color: white; padding: 4px 10px; border-radius: 999px; font-size: 11px; font-weight: 600; margin-bottom: 8px;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                    </svg>
                    NHS Ready
                </span>
                <h2 class="insight-card__title" style="color: white;">Data Export for Healthcare Provider</h2>
                <p class="insight-card__subtitle" style="color: rgba(255,255,255,0.8);">Comprehensive PDF or CSV export</p>
            </div>
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14,2 14,8 20,8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
            </svg>
        </div>
        
        <div style="display: grid; gap: 8px; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: rgba(255,255,255,0.9);">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                UAS7 scoring per international guidelines
            </div>
            <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: rgba(255,255,255,0.9);">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                Treatment response &amp; flare analysis
            </div>
            <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: rgba(255,255,255,0.9);">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                Clinical decision support guidance
            </div>
        </div>
        
        <a href="{% url 'tracking:export' %}" class="btn" style="width: 100%; background: white; color: #005EB8; border: none; font-weight: 600;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7,10 12,15 17,10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Create Data Export
        </a>
    </div>
    
    <!-- Disclaimer -->
    <p class="disclaimer-text">
        ðŸ“Š These insights are for personal tracking only and should not be considered medical advice. 
        Share this data with your healthcare provider for proper evaluation.
    </p>
    
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/components.js' %}"></script>
<script>
// Animate progress ring on load
document.addEventListener('DOMContentLoaded', function() {
    const progressCircle = document.querySelector('.progress-ring__progress');
    if (progressCircle) {
        const offset = progressCircle.getAttribute('stroke-dashoffset');
        progressCircle.style.strokeDashoffset = '327'; // Start at 0%
        requestAnimationFrame(() => {
            progressCircle.style.transition = 'stroke-dashoffset 1s ease-out';
            progressCircle.style.strokeDashoffset = offset;
        });
    }
    
    // Animate bars
    document.querySelectorAll('.average-bar__fill').forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        requestAnimationFrame(() => {
            bar.style.width = width;
        });
    });
});
</script>
{% endblock %}
