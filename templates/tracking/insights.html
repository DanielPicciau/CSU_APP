{% extends 'base_new.html' %}
{% load static %}
{% load tracking_tags %}

{% block title %}Insights - CSU Tracker{% endblock %}

{% block extra_head %}
<style>
/* â”€â”€ Insights page refinements â”€â”€ */
.insight-card {
    background: var(--surface-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-2xl);
    overflow: hidden;
    margin-bottom: var(--space-5);
}
.insight-card__header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-4) var(--space-5);
    border-bottom: 1px solid var(--border-subtle);
    background: var(--bg-secondary);
}
.insight-card__header--plain {
    background: transparent;
    border-bottom: none;
    justify-content: space-between;
}
.insight-card__icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.insight-card__icon--adherence { background: linear-gradient(135deg, #34D399, #10B981); }
.insight-card__icon--stats { background: linear-gradient(135deg, #818CF8, #6366F1); }
.insight-card__icon--trend { background: linear-gradient(135deg, #60A5FA, #3B82F6); }
.insight-card__icon--averages { background: linear-gradient(135deg, #FBBF24, #F59E0B); }
.insight-card__icon--weekly { background: linear-gradient(135deg, #F472B6, #EC4899); }
.insight-card__icon--meds { background: linear-gradient(135deg, #A78BFA, #8B5CF6); }
.insight-card__title {
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    margin: 0;
}
.insight-card__subtitle {
    font-size: var(--text-xs);
    color: var(--text-secondary);
    margin: 0;
}
.insight-card__body {
    padding: var(--space-5);
}

.stat-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-3);
}
.stat-item {
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    text-align: center;
}
.stat-item__value {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--text-primary);
}
.stat-item__label {
    font-size: var(--text-xs);
    color: var(--text-secondary);
    margin-top: var(--space-1);
}
.stat-item--highlight .stat-item__value { color: var(--color-primary-600); }
.stat-item--success .stat-item__value { color: var(--color-success-600); }
.stat-item--warning .stat-item__value { color: var(--color-warning-600); }

.progress-ring {
    position: relative;
    width: 120px;
    height: 120px;
    margin: 0 auto;
}
.progress-ring__svg { transform: rotate(-90deg); }
.progress-ring__circle {
    fill: none;
    stroke: var(--bg-tertiary);
    stroke-width: 8;
}
.progress-ring__progress {
    fill: none;
    stroke: var(--color-primary-500);
    stroke-width: 8;
    stroke-linecap: round;
    transition: stroke-dashoffset 1s cubic-bezier(0.34, 1.56, 0.64, 1);
    filter: drop-shadow(0 0 3px rgba(99, 102, 241, 0.3));
}
.progress-ring__text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}
.progress-ring__value {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--text-primary);
    font-variant-numeric: tabular-nums;
}
.progress-ring__label {
    font-size: var(--text-xs);
    color: var(--text-secondary);
}

.trend-chart {
    height: 200px;
    position: relative;
    padding: var(--space-4) 0 var(--space-2);
    overflow: visible;
}
.trend-chart__svg {
    width: 100%;
    height: 100%;
    overflow: visible;
}
.trend-chart__line {
    fill: none;
    stroke: var(--color-primary-500);
    stroke-width: 2.5;
    stroke-linecap: round;
    stroke-linejoin: round;
    filter: drop-shadow(0 1px 2px rgba(99, 102, 241, 0.3));
    stroke-dasharray: 2000;
    stroke-dashoffset: 2000;
    animation: trendLineIn 1.2s ease forwards 0.2s;
}
@keyframes trendLineIn {
    to { stroke-dashoffset: 0; }
}
.trend-chart__area {
    fill: url(#gradient);
    opacity: 0.25;
    animation: trendAreaIn 0.8s ease forwards 0.4s;
    opacity: 0;
}
@keyframes trendAreaIn {
    to { opacity: 0.25; }
}
.trend-chart__point {
    fill: var(--color-primary-500);
    stroke: var(--surface-primary);
    stroke-width: 2.5;
    r: 4;
    cursor: pointer;
    transition: r 0.2s ease, filter 0.2s ease;
    opacity: 0;
    animation: pointFadeIn 0.3s ease forwards;
}
.trend-chart__point:hover,
.trend-chart__point:focus {
    r: 7;
    filter: drop-shadow(0 0 4px var(--color-primary-400));
}
/* Touch target â€” invisible larger circle for mobile tap */
.trend-chart__point-target {
    fill: transparent;
    r: 16;
    cursor: pointer;
}
@keyframes pointFadeIn {
    from { opacity: 0; transform: scale(0); }
    to { opacity: 1; transform: scale(1); }
}
.trend-chart__grid-line {
    stroke: var(--border-subtle);
    stroke-dasharray: 4 4;
    stroke-width: 0.5;
}
.trend-chart__label {
    fill: var(--text-tertiary);
    font-size: 10px;
    font-weight: 500;
}
.trend-chart__x-label {
    fill: var(--text-tertiary);
    font-size: 9px;
    text-anchor: middle;
}
.trend-chart__severity-zone {
    opacity: 0.04;
}
.trend-chart__avg-line {
    stroke: var(--color-primary-300);
    stroke-width: 1;
    stroke-dasharray: 6 4;
    opacity: 0.6;
}
.trend-chart__tooltip {
    position: absolute;
    background: var(--surface-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-xs);
    box-shadow: var(--shadow-lg);
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s ease;
    z-index: 10;
    white-space: nowrap;
}
.trend-chart__tooltip--visible {
    opacity: 1;
}

.average-bars {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}
.average-bar {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}
.average-bar__label {
    width: 80px;
    font-size: var(--text-sm);
    color: var(--text-secondary);
    flex-shrink: 0;
    font-weight: var(--font-medium);
}
.average-bar__track {
    flex: 1;
    height: 10px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-full);
    overflow: hidden;
    position: relative;
}
.average-bar__fill {
    height: 100%;
    border-radius: var(--radius-full);
    position: relative;
}
.average-bar__fill::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: 40%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2));
    border-radius: var(--radius-full);
}
.average-bar__value {
    width: 44px;
    text-align: right;
    font-size: var(--text-sm);
    font-weight: var(--font-bold);
    color: var(--text-primary);
    flex-shrink: 0;
    font-variant-numeric: tabular-nums;
}

.week-comparison {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-2);
}
.week-block {
    text-align: center;
    padding: var(--space-3) var(--space-2);
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    position: relative;
    overflow: hidden;
}
.week-block:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
}
.week-block--current {
    background: var(--bg-brand-subtle);
    border: 2px solid var(--border-brand);
}
.week-block--current::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--color-primary-500);
    border-radius: var(--radius-full);
}
.week-block__bar {
    width: 60%;
    margin: 0 auto var(--space-2);
    height: 4px;
    border-radius: var(--radius-full);
    background: var(--bg-tertiary);
    overflow: hidden;
}
.week-block__bar-fill {
    height: 100%;
    border-radius: var(--radius-full);
    transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.week-block__score {
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
    font-variant-numeric: tabular-nums;
    line-height: 1.2;
}
.week-block__label {
    font-size: var(--text-xs);
    color: var(--text-secondary);
    margin-top: var(--space-1);
}
.week-block__change {
    display: inline-flex;
    align-items: center;
    gap: 2px;
    font-size: 11px;
    font-weight: var(--font-semibold);
    margin-top: var(--space-1);
    padding: 1px 6px;
    border-radius: var(--radius-full);
}
.week-block__change--up {
    color: var(--color-error-600);
    background: var(--color-error-50);
}
.week-block__change--down {
    color: var(--color-success-600);
    background: var(--color-success-50);
}
.week-block__change--same {
    color: var(--text-tertiary);
    background: var(--bg-tertiary);
}

.period-toggle {
    display: inline-flex;
    background: var(--surface-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-full);
    padding: 3px;
    gap: 2px;
}
.period-toggle__btn {
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--text-secondary);
    border: none;
    background: transparent;
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-out);
    text-decoration: none;
}
.period-toggle__btn--active {
    background: var(--bg-brand-subtle);
    color: var(--text-brand);
    font-weight: var(--font-semibold);
}
.period-toggle__btn--disabled {
    opacity: 0.4;
    cursor: not-allowed;
    pointer-events: none;
}

.history-limit-banner {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-3) var(--space-4);
    background: var(--color-warning-50);
    border: 1px solid var(--color-warning-200);
    border-radius: var(--radius-lg);
    margin: 0 auto var(--space-4);
    font-size: var(--text-sm);
    color: var(--text-secondary);
    max-width: 520px;
}
[data-theme="dark"] .history-limit-banner {
    background: rgba(245, 158, 11, 0.1);
    border-color: rgba(245, 158, 11, 0.3);
}

/* Export CTA */
.export-cta {
    background: linear-gradient(135deg, #005EB8 0%, #003D7A 100%);
    border: none;
    position: relative;
    overflow: hidden;
}
.export-cta::before {
    content: '';
    position: absolute;
    top: -30%;
    right: -10%;
    width: 160px;
    height: 160px;
    background: rgba(255,255,255,0.06);
    border-radius: var(--radius-full);
}
.export-cta .insight-card__header {
    background: transparent;
    border-bottom: none;
    position: relative;
    z-index: 1;
}
.export-cta .insight-card__body {
    position: relative;
    z-index: 1;
}

.disclaimer-text {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
    text-align: center;
    padding: var(--space-4);
    margin-top: var(--space-4);
    border-top: 1px solid var(--border-subtle);
}
</style>
{% endblock %}

{% block header_left %}
<a href="{% url 'tracking:today' %}" class="btn btn--icon btn--ghost" aria-label="Back to today">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
    </svg>
</a>
{% endblock %}

{% block header_title %}Insights{% endblock %}

{% block header_right %}
<a href="{% url 'tracking:history' %}" class="btn btn--icon btn--ghost" aria-label="View history">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
        <line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
    </svg>
</a>
{% endblock %}

{% block content %}
<div class="app-content">
    
    <!-- Period Toggle -->
    <div class="text-center mb-5">
        <div class="period-toggle">
            <a href="?period=7" class="period-toggle__btn {% if period == 7 %}period-toggle__btn--active{% endif %}">7 days</a>
            <a href="?period=30" class="period-toggle__btn {% if period == 30 %}period-toggle__btn--active{% endif %}">30 days</a>
            <a href="{% if history_limited %}#{% else %}?period=90{% endif %}" class="period-toggle__btn {% if period == 90 %}period-toggle__btn--active{% endif %} {% if history_limited %}period-toggle__btn--disabled{% endif %}">90 days</a>
        </div>
    </div>

    {% if history_limited %}
    <div class="history-limit-banner">
        Free tier insights are limited to the last {{ history_limit_days }} days.
        <a href="{% url 'subscriptions:premium' %}" style="margin-left: 6px; font-weight: 600; text-decoration: underline;">Upgrade</a>
    </div>
    {% endif %}
    
    <!-- Adherence Card -->
    <div class="insight-card">
        <div class="insight-card__header">
            <div class="insight-card__icon insight-card__icon--adherence">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
            </div>
            <div>
                <h2 class="insight-card__title">Tracking Adherence</h2>
                <p class="insight-card__subtitle">Last {{ period }} days</p>
            </div>
        </div>
        
        <div class="insight-card__body">
            <div style="display: flex; align-items: center; justify-content: space-around;">
                <div class="progress-ring">
                    <svg class="progress-ring__svg" width="120" height="120" viewBox="0 0 120 120">
                        <circle class="progress-ring__circle" cx="60" cy="60" r="52"/>
                        <circle 
                            class="progress-ring__progress" 
                            cx="60" cy="60" r="52"
                            stroke-dasharray="327"
                            stroke-dashoffset="{{ adherence_offset }}"
                        />
                    </svg>
                    <div class="progress-ring__text">
                        <div class="progress-ring__value">{{ adherence_pct|floatformat:0 }}%</div>
                        <div class="progress-ring__label">logged</div>
                    </div>
                </div>
                
                <div class="stat-grid" style="flex: 1; max-width: 180px;">
                    <div class="stat-item stat-item--highlight">
                        <div class="stat-item__value">{{ logged_days }}</div>
                        <div class="stat-item__label">Logged</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item__value">{{ missing_days }}</div>
                        <div class="stat-item__label">Missing</div>
                    </div>
                </div>
            </div>
            
            {% if missing_days > 0 %}
            <div style="margin-top: var(--space-4); text-align: center;">
                <a href="{% url 'tracking:history' %}?show=missing&days={{ period }}" class="btn btn--secondary btn--sm">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Fill {{ missing_days }} missing {% if missing_days == 1 %}day{% else %}days{% endif %}
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Logging Stats Card -->
    <div class="insight-card">
        <div class="insight-card__header">
            <div class="insight-card__icon insight-card__icon--stats">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
            </div>
            <div>
                <h2 class="insight-card__title">Your Logging</h2>
                <p class="insight-card__subtitle">Tracking consistency</p>
            </div>
        </div>
        
        <div class="insight-card__body">
            <div class="stat-grid">
                <div class="stat-item stat-item--highlight">
                    <div class="stat-item__value">{{ logged_days }}</div>
                    <div class="stat-item__label">Days in Period</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__value">{{ total_entries }}</div>
                    <div class="stat-item__label">All-Time Entries</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Score Trend Chart -->
    <div class="insight-card">
        <div class="insight-card__header">
            <div class="insight-card__icon insight-card__icon--trend">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                </svg>
            </div>
            <div>
                <h2 class="insight-card__title">Score Trend</h2>
                <p class="insight-card__subtitle">Daily scores over time</p>
            </div>
        </div>
        
        <div class="insight-card__body">
            <div class="trend-chart" id="trend-chart">
            <svg class="trend-chart__svg" viewBox="0 0 {{ chart_width }} 160" preserveAspectRatio="xMidYMid meet">
                <defs>
                    <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color: var(--color-primary-500); stop-opacity: 0.4;"/>
                        <stop offset="70%" style="stop-color: var(--color-primary-500); stop-opacity: 0.08;"/>
                        <stop offset="100%" style="stop-color: var(--color-primary-500); stop-opacity: 0;"/>
                    </linearGradient>
                    <filter id="glow">
                        <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                        <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
                    </filter>
                </defs>
                
                <!-- Severity zone backgrounds -->
                <rect class="trend-chart__severity-zone" x="20" y="5" width="{{ chart_width|add:-25 }}" height="35" fill="var(--color-error-500)" rx="2"/>
                <rect class="trend-chart__severity-zone" x="20" y="40" width="{{ chart_width|add:-25 }}" height="35" fill="var(--color-warning-500)" rx="2"/>
                <rect class="trend-chart__severity-zone" x="20" y="75" width="{{ chart_width|add:-25 }}" height="55" fill="var(--color-success-500)" rx="2"/>
                
                <!-- Grid lines -->
                <line class="trend-chart__grid-line" x1="20" y1="25" x2="{{ chart_width }}" y2="25"/>
                <line class="trend-chart__grid-line" x1="20" y1="75" x2="{{ chart_width }}" y2="75"/>
                <line class="trend-chart__grid-line" x1="20" y1="130" x2="{{ chart_width }}" y2="130"/>
                
                <!-- Y-axis labels -->
                <text class="trend-chart__label" x="16" y="29" text-anchor="end">6</text>
                <text class="trend-chart__label" x="16" y="79" text-anchor="end">3</text>
                <text class="trend-chart__label" x="16" y="134" text-anchor="end">0</text>
                
                {% if chart_path %}
                <!-- Average line -->
                {% if avg_score_y %}
                <line class="trend-chart__avg-line" x1="20" y1="{{ avg_score_y }}" x2="{{ chart_width }}" y2="{{ avg_score_y }}"/>
                {% endif %}
                
                <!-- Area fill -->
                <path class="trend-chart__area" d="{{ chart_area_path }}"/>
                
                <!-- Line with glow -->
                <path class="trend-chart__line" d="{{ chart_path }}" filter="url(#glow)"/>
                
                <!-- Interactive points with larger touch targets -->
                {% for point in chart_points %}
                <circle class="trend-chart__point-target" cx="{{ point.x }}" cy="{{ point.y }}" data-score="{{ point.score }}"/>
                <circle class="trend-chart__point" cx="{{ point.x }}" cy="{{ point.y }}" r="4" data-score="{{ point.score }}" style="animation-delay: {{ forloop.counter0 }}50ms;"/>
                {% endfor %}
                
                <!-- X-axis date labels (first and last) -->
                {% if chart_points %}
                {% with first=chart_points.0 last_point=chart_points|last %}
                <text class="trend-chart__x-label" x="{{ first.x }}" y="148">{{ first.date }}</text>
                <text class="trend-chart__x-label" x="{{ last_point.x }}" y="148">{{ last_point.date }}</text>
                {% endwith %}
                {% endif %}
                {% else %}
                <!-- No data message -->
                <text x="{{ chart_width|floatformat:0|add:0 }}" y="75" text-anchor="middle" fill="var(--text-tertiary)" font-size="13" x="150">
                    {% if logged_days == 0 %}
                    No entries yet â€” log your first day!
                    {% elif logged_days == 1 %}
                    Log one more day to see trends
                    {% else %}
                    Not enough data to show trend
                    {% endif %}
                </text>
                {% endif %}
            </svg>
            <!-- Tooltip (positioned via JS) -->
            <div class="trend-chart__tooltip" id="trend-tooltip"></div>
            </div>
        </div>
    </div>
    
    <!-- Averages Card -->
    <div class="insight-card">
        <div class="insight-card__header">
            <div class="insight-card__icon insight-card__icon--averages">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
            </div>
            <div>
                <h2 class="insight-card__title">Score Averages</h2>
                <p class="insight-card__subtitle">Based on {{ logged_days }} logged {% if logged_days == 1 %}day{% else %}days{% endif %}</p>
            </div>
        </div>
        
        <div class="insight-card__body">
            <div class="average-bars">
            <div class="average-bar">
                <span class="average-bar__label">Total Score</span>
                <div class="average-bar__track">
                    <div class="average-bar__fill" style="width: {{ avg_score_pct }}%; background: linear-gradient(90deg, var(--color-score-0), var(--color-score-3), var(--color-score-6));"></div>
                </div>
                <span class="average-bar__value">{{ avg_score|floatformat:1 }}</span>
            </div>
            <div class="average-bar">
                <span class="average-bar__label">Itch</span>
                <div class="average-bar__track">
                    <div class="average-bar__fill" style="width: {{ avg_itch_pct }}%; background: var(--color-primary-500);"></div>
                </div>
                <span class="average-bar__value">{{ avg_itch|floatformat:1 }}</span>
            </div>
            <div class="average-bar">
                <span class="average-bar__label">Hives</span>
                <div class="average-bar__track">
                    <div class="average-bar__fill" style="width: {{ avg_hives_pct }}%; background: var(--color-secondary-500);"></div>
                </div>
                <span class="average-bar__value">{{ avg_hives|floatformat:1 }}</span>
            </div>
        </div>
        
        <div class="stat-grid" style="margin-top: var(--space-5);">
            <div class="stat-item">
                <div class="stat-item__value">{{ best_score }}</div>
                <div class="stat-item__label">Best Day</div>
            </div>
            <div class="stat-item">
                <div class="stat-item__value">{{ worst_score }}</div>
                <div class="stat-item__label">Worst Day</div>
            </div>
        </div>
        </div>
    </div>
    
    <!-- Weekly UAS7 Comparison -->
    <div class="insight-card">
        <div class="insight-card__header">
            <div class="insight-card__icon insight-card__icon--weekly">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
            </div>
            <div>
                <h2 class="insight-card__title">Weekly UAS7</h2>
                <p class="insight-card__subtitle">Last 4 weeks comparison</p>
            </div>
        </div>
        
        <div class="insight-card__body">
            <div class="week-comparison">
            {% for week in weekly_scores %}
            <div class="week-block {% if forloop.first %}week-block--current{% endif %}">
                <div class="week-block__bar">
                    <div class="week-block__bar-fill" style="width: {% widthratio week.uas7 42 100 %}%; background: {% if week.uas7 <= 6 %}var(--color-score-0){% elif week.uas7 <= 15 %}var(--color-score-2){% elif week.uas7 <= 27 %}var(--color-score-4){% else %}var(--color-score-6){% endif %};"></div>
                </div>
                <div class="week-block__score" style="color: {% if week.uas7 <= 6 %}var(--color-score-0){% elif week.uas7 <= 15 %}var(--color-score-2){% elif week.uas7 <= 27 %}var(--color-score-4){% else %}var(--color-score-6){% endif %};">
                    {% if week.complete %}{{ week.uas7 }}{% else %}{{ week.uas7 }}*{% endif %}
                </div>
                <div class="week-block__label">
                    {% if forloop.first %}This week{% else %}{{ week.label }}{% endif %}
                </div>
                {% if not forloop.first and week.change is not None %}
                <div class="week-block__change {% if week.change > 0 %}week-block__change--up{% elif week.change < 0 %}week-block__change--down{% else %}week-block__change--same{% endif %}">
                    {% if week.change > 0 %}â†‘ {{ week.change }}{% elif week.change < 0 %}â†“ {{ week.change|abs }}{% else %}â†’ 0{% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        
        <p style="font-size: var(--text-xs); color: var(--text-tertiary); text-align: center; margin-top: var(--space-3);">* Incomplete week</p>
        </div>
    </div>
    
    <!-- Antihistamine Stats -->
    {% if antihistamine_days > 0 %}
    <div class="insight-card">
        <div class="insight-card__header">
            <div class="insight-card__icon insight-card__icon--meds">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
                </svg>
            </div>
            <div>
                <h2 class="insight-card__title">Antihistamine Usage</h2>
                <p class="insight-card__subtitle">Last {{ period }} days</p>
            </div>
        </div>
        
        <div class="insight-card__body">
            <div class="stat-grid">
                <div class="stat-item">
                    <div class="stat-item__value">{{ antihistamine_days }}</div>
                    <div class="stat-item__label">Days Taken</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__value">{{ antihistamine_pct|floatformat:0 }}%</div>
                    <div class="stat-item__label">Of Logged Days</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Export Data Card - Enhanced for NHS -->
    <div class="insight-card export-cta">
        <div class="insight-card__header" style="border-bottom: none; background: transparent; justify-content: space-between;">
            <div>
                <span style="display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.15); color: white; padding: 4px 10px; border-radius: 999px; font-size: 11px; font-weight: 600; margin-bottom: 8px;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                    </svg>
                    NHS Ready
                </span>
                <h2 class="insight-card__title" style="color: white;">Data Export for Healthcare Provider</h2>
                <p class="insight-card__subtitle" style="color: rgba(255,255,255,0.75);">Comprehensive PDF or CSV export</p>
            </div>
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="flex-shrink: 0;">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14,2 14,8 20,8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
            </svg>
        </div>
        
        <div class="insight-card__body" style="padding-top: 0;">
            <div style="display: grid; gap: 8px; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: rgba(255,255,255,0.9);">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                    UAS7 scoring per international guidelines
                </div>
                <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: rgba(255,255,255,0.9);">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                    Treatment response &amp; flare analysis
                </div>
                <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: rgba(255,255,255,0.9);">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                    Clinical decision support guidance
                </div>
            </div>
            
            <a href="{% url 'tracking:export' %}" class="btn" style="width: 100%; background: white; color: #005EB8; border: none; font-weight: 600; border-radius: var(--radius-xl);">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7,10 12,15 17,10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Create Data Export
            </a>
        </div>
    </div>
    
    <!-- Disclaimer -->
    <p class="disclaimer-text">
        ðŸ“Š These insights are for personal tracking only and should not be considered medical advice. 
        Share this data with your healthcare provider for proper evaluation.
    </p>
    
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/components.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // â”€â”€ Trend chart tooltip interaction â”€â”€
    const trendChart = document.getElementById('trend-chart');
    const tooltip = document.getElementById('trend-tooltip');
    if (trendChart && tooltip) {
        const points = trendChart.querySelectorAll('.trend-chart__point, .trend-chart__point-target');
        const chartRect = () => trendChart.getBoundingClientRect();
        const svgEl = trendChart.querySelector('.trend-chart__svg');
        
        function showTooltip(e) {
            const target = e.target.closest('.trend-chart__point, .trend-chart__point-target');
            if (!target) return;
            const score = target.getAttribute('data-score');
            if (score === null) return;
            
            const cx = parseFloat(target.getAttribute('cx'));
            const cy = parseFloat(target.getAttribute('cy'));
            const svgRect = svgEl.getBoundingClientRect();
            const viewBox = svgEl.viewBox.baseVal;
            
            // Convert SVG coords to pixel coords
            const scaleX = svgRect.width / viewBox.width;
            const scaleY = svgRect.height / viewBox.height;
            const px = cx * scaleX;
            const py = cy * scaleY;
            
            const severityLabels = ['None', 'Mild', 'Low-Mod', 'Moderate', 'High-Mod', 'Severe', 'V. Severe'];
            tooltip.innerHTML = '<strong>' + score + '/6</strong> <span style="color: var(--text-tertiary);">' + severityLabels[parseInt(score)] + '</span>';
            tooltip.classList.add('trend-chart__tooltip--visible');
            
            // Position tooltip
            const tw = tooltip.offsetWidth;
            let left = px - tw / 2;
            if (left < 0) left = 4;
            if (left + tw > svgRect.width) left = svgRect.width - tw - 4;
            tooltip.style.left = left + 'px';
            tooltip.style.top = (py - 36) + 'px';
        }
        
        function hideTooltip() {
            tooltip.classList.remove('trend-chart__tooltip--visible');
        }
        
        points.forEach(function(pt) {
            pt.addEventListener('mouseenter', showTooltip);
            pt.addEventListener('mouseleave', hideTooltip);
            pt.addEventListener('touchstart', function(e) {
                e.preventDefault();
                showTooltip(e);
                setTimeout(hideTooltip, 2000);
            }, { passive: false });
        });
    }
    
    // â”€â”€ Animate average bars on scroll into view â”€â”€
    const avgBars = document.querySelectorAll('.average-bar__fill');
    if (avgBars.length && 'IntersectionObserver' in window) {
        const obs = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
                if (entry.isIntersecting) {
                    entry.target.style.width = entry.target.getAttribute('data-width');
                    obs.unobserve(entry.target);
                }
            });
        }, { threshold: 0.3 });
        
        avgBars.forEach(function(bar) {
            // Store target width and start at 0
            const targetWidth = bar.style.width;
            bar.setAttribute('data-width', targetWidth);
            bar.style.width = '0';
            bar.style.transition = 'width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1)';
            obs.observe(bar);
        });
    }
    
    // â”€â”€ Animate progress ring on load â”€â”€
    const ringProgress = document.querySelector('.progress-ring__progress');
    if (ringProgress) {
        const targetOffset = ringProgress.getAttribute('stroke-dashoffset');
        ringProgress.setAttribute('stroke-dashoffset', '327');
        requestAnimationFrame(function() {
            requestAnimationFrame(function() {
                ringProgress.style.strokeDashoffset = targetOffset;
            });
        });
    }
    
    // â”€â”€ Animate week comparison bars on scroll â”€â”€
    const weekBars = document.querySelectorAll('.week-block__bar-fill');
    if (weekBars.length && 'IntersectionObserver' in window) {
        const weekObs = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
                if (entry.isIntersecting) {
                    entry.target.style.width = entry.target.getAttribute('data-width');
                    weekObs.unobserve(entry.target);
                }
            });
        }, { threshold: 0.3 });
        
        weekBars.forEach(function(bar) {
            const targetWidth = bar.style.width;
            bar.setAttribute('data-width', targetWidth);
            bar.style.width = '0';
            weekObs.observe(bar);
        });
    }
});
</script>

{% endblock %}
