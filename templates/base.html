<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#4F46E5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CSU Tracker">
    
    <!-- Performance: DNS prefetch for external resources -->
    <link rel="dns-prefetch" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
    
    <title>{% block title %}CSU Tracker{% endblock %}</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{% url 'manifest' %}">
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
    
    <!-- 
    SECURITY NOTE: For production, replace CDN scripts with:
    1. Self-hosted versions, OR
    2. Add SRI hashes (integrity attribute) - generate at https://www.srihash.org/
    
    Tailwind CDN is for development only. For production:
    - Build Tailwind locally: npx tailwindcss -o static/css/tailwind.min.css --minify
    - HTMX: Download and serve from /static/js/htmx.min.js
    -->
    
    <!-- Tailwind CSS (CDN for dev - see security note above) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        'primary-dark': '#4338CA',
                    }
                }
            }
        }
    </script>
    
    <!-- HTMX with SRI hash -->
    <script src="https://unpkg.com/htmx.org@1.9.10" 
            integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHez7Nber6bPLCIHCDHBMQc0lfmjzJgDLCz0w" 
            crossorigin="anonymous"></script>
    
    <!-- Animation & Performance CSS -->
    <link rel="stylesheet" href="/static/css/animations.css">
    
    <!-- Desktop Layout CSS -->
    <link rel="stylesheet" href="/static/css/desktop.css">
    
    <!-- Custom Styles -->
    <style>
        /* iOS safe area handling */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        
        /* Prevent pull-to-refresh on iOS */
        body {
            overscroll-behavior-y: contain;
        }
        
        /* Smooth transitions */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Score colors */
        .score-0 { background-color: #10B981; }
        .score-1 { background-color: #34D399; }
        .score-2 { background-color: #FCD34D; }
        .score-3 { background-color: #FBBF24; }
        .score-4 { background-color: #F97316; }
        .score-5 { background-color: #EF4444; }
        .score-6 { background-color: #DC2626; }
        
        /* Radio button cards */
        .radio-card {
            @apply cursor-pointer border-2 rounded-xl p-4 transition-all;
        }
        .radio-card:has(input:checked) {
            @apply border-indigo-500 bg-indigo-50;
        }
        
        /* Performance: will-change hints */
        .card-animated {
            will-change: transform;
        }
        
        /* Loading states */
        .loading {
            pointer-events: none;
            opacity: 0.7;
        }
    </style>
    
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    {% if user.is_authenticated %}
    <!-- Desktop Sidebar Navigation (Hidden on mobile via CSS) -->
    <aside class="desktop-sidebar" style="display: none;">
        <!-- Logo -->
        <div class="desktop-sidebar-logo">
            <div class="desktop-sidebar-logo-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                </svg>
            </div>
            <span class="desktop-sidebar-logo-text">CSU Tracker</span>
        </div>
        
        <!-- Navigation -->
        <nav class="desktop-sidebar-nav">
            <a href="{% url 'home' %}" class="desktop-nav-item {% if request.resolver_match.url_name == 'home' %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                Dashboard
            </a>
            
            <a href="{% url 'tracking:log_entry' %}" class="desktop-nav-item log-button {% if 'log' in request.path %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Log Entry
            </a>
            
            <div class="desktop-nav-divider"></div>
            
            <a href="{% url 'tracking:history' %}" class="desktop-nav-item {% if 'history' in request.path %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                History
            </a>
            
            <a href="{% url 'notifications:settings' %}" class="desktop-nav-item {% if 'notifications' in request.path %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                </svg>
                Notifications
            </a>
            
            <a href="{% url 'tracking:export' %}" class="desktop-nav-item {% if 'export' in request.path %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                Export Data
            </a>
        </nav>
        
        <!-- User Section -->
        <div class="desktop-sidebar-user">
            <div class="desktop-sidebar-user-info">
                <div class="desktop-sidebar-user-avatar">
                    {{ user.email.0|upper }}
                </div>
                <span class="desktop-sidebar-user-email">{{ user.email }}</span>
            </div>
            <div class="desktop-sidebar-user-actions">
                <a href="{% url 'accounts:profile' %}" class="desktop-user-action-btn profile">
                    Profile
                </a>
                <form method="post" action="{% url 'accounts:logout' %}" style="flex: 1;">
                    {% csrf_token %}
                    <button type="submit" class="desktop-user-action-btn logout" style="width: 100%;">
                        Sign Out
                    </button>
                </form>
            </div>
        </div>
    </aside>
    {% endif %}

    <!-- Main Content Wrapper (margin added on desktop via CSS) -->
    <div class="desktop-main">
    <!-- Main Content -->
    <main class="flex-1 pb-20 desktop-content">
        {% if messages %}
        <div class="px-4 pt-4 stagger-animation stagger-fast">
            {% for message in messages %}
            <div class="mb-2 p-4 rounded-lg {% if message.tags == 'error' %}bg-red-100 text-red-800{% elif message.tags == 'success' %}bg-green-100 text-green-800{% else %}bg-blue-100 text-blue-800{% endif %} toast-enter">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        {% block content %}{% endblock %}
    </main>
    
    {% if user.is_authenticated %}
    <!-- Bottom Navigation (Mobile Only) -->
    <nav class="mobile-nav fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-4 py-2 safe-area-bottom" style="backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); background-color: rgba(255,255,255,0.9);">
        <div class="flex justify-around items-center max-w-md mx-auto">
            <a href="{% url 'home' %}" class="flex flex-col items-center py-2 px-4 {% if request.resolver_match.url_name == 'home' %}text-indigo-600{% else %}text-gray-500{% endif %} tap-highlight transition-transform duration-150 active:scale-95">
                <svg class="w-6 h-6 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                <span class="text-xs mt-1">Home</span>
            </a>
            
            <a href="{% url 'tracking:log_entry' %}" class="flex flex-col items-center py-2 px-4 {% if 'log' in request.path %}text-indigo-600{% else %}text-gray-500{% endif %} tap-highlight transition-transform duration-150 active:scale-95">
                <div class="bg-indigo-600 rounded-full p-3 -mt-6 shadow-lg transition-all duration-200 hover:shadow-xl hover:scale-105 active:scale-95 animate-glow">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                </div>
                <span class="text-xs mt-1">Log</span>
            </a>
            
            <a href="{% url 'tracking:history' %}" class="flex flex-col items-center py-2 px-4 {% if 'history' in request.path %}text-indigo-600{% else %}text-gray-500{% endif %} tap-highlight transition-transform duration-150 active:scale-95">
                <svg class="w-6 h-6 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                <span class="text-xs mt-1">History</span>
            </a>
            
            <a href="{% url 'notifications:settings' %}" class="flex flex-col items-center py-2 px-4 {% if 'notifications' in request.path %}text-indigo-600{% else %}text-gray-500{% endif %} tap-highlight transition-transform duration-150 active:scale-95">
                <svg class="w-6 h-6 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                </svg>
                <span class="text-xs mt-1">Alerts</span>
            </a>
        </div>
    </nav>
    {% endif %}
    
    </div><!-- End .desktop-main -->
    
    <!-- Performance JavaScript -->
    <script src="/static/js/performance.js" defer></script>

    {% include "components/consent_banner.html" %}
    
    <!-- Push Notification Permission Script -->
    <script>
        const VAPID_PUBLIC_KEY = '{{ VAPID_PUBLIC_KEY }}';
        
        // Force clear all caches and re-register service worker
        if ('serviceWorker' in navigator) {
            // First, clear ALL caches to fix Safari redirect issue
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                        console.log('Cleared cache:', name);
                    }
                });
            }
            
            // Unregister any existing service workers first
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for (let registration of registrations) {
                    registration.unregister().then(function() {
                        console.log('Unregistered old SW');
                    });
                }
            }).then(function() {
                // Register fresh service worker
                navigator.serviceWorker.register('/sw.js', { updateViaCache: 'none' })
                    .then(reg => {
                        console.log('Service Worker registered');
                        reg.update();
                    })
                    .catch(err => console.error('SW registration failed:', err));
            });
        }
        
        // Instant navigation feedback for bottom nav
        (function() {
            document.addEventListener('click', function(e) {
                var navItem = e.target.closest('.mobile-nav a');
                if (navItem) {
                    // Immediately change color for instant visual feedback
                    navItem.style.color = '#4F46E5';
                    
                    // Trigger haptic feedback if available
                    if (navigator.vibrate) {
                        navigator.vibrate(10);
                    }
                    
                    // Fade out content immediately for perceived speed
                    var main = document.querySelector('main');
                    if (main) {
                        main.style.opacity = '0.6';
                        main.style.transition = 'opacity 0.1s ease';
                    }
                }
            }, { passive: true });
        })();
    </script>
    
    <!-- Desktop Layout JavaScript -->
    <script>
    (function() {
        // Desktop detection and layout initialization
        function initDesktopLayout() {
            var isDesktop = window.innerWidth >= 1024;
            document.body.classList.toggle('desktop-layout', isDesktop);
            
            // Show/hide desktop elements
            var sidebar = document.querySelector('.desktop-sidebar');
            if (sidebar) {
                sidebar.style.display = isDesktop ? 'flex' : 'none';
            }
        }
        
        // Initialize on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDesktopLayout);
        } else {
            initDesktopLayout();
        }
        
        // Handle window resize with debounce
        var resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(initDesktopLayout, 100);
        });
        
        // Desktop keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Only on desktop and not in input fields
            if (window.innerWidth < 1024) return;
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
            if (e.ctrlKey || e.metaKey || e.altKey) return;
            
            switch(e.key.toLowerCase()) {
                case 'l':
                    e.preventDefault();
                    window.location.href = '{% url "tracking:log_entry" %}';
                    break;
                case 'h':
                    e.preventDefault();
                    window.location.href = '{% url "home" %}';
                    break;
                case 'g':
                    e.preventDefault();
                    window.location.href = '{% url "tracking:history" %}';
                    break;
                case 'n':
                    e.preventDefault();
                    window.location.href = '{% url "notifications:settings" %}';
                    break;
            }
        });
    })();
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
